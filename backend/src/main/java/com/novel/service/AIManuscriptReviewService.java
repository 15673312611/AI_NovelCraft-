package com.novel.service;

import com.novel.dto.AIConfigRequest;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.MediaType;
import org.springframework.http.client.SimpleClientHttpRequestFactory;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * AIå®¡ç¨¿æœåŠ¡
 */
@Service
public class AIManuscriptReviewService {

    private static final Logger logger = LoggerFactory.getLogger(AIManuscriptReviewService.class);

    private static final String REVIEW_SYSTEM_PROMPT = buildReviewSystemPrompt();

    private static String buildReviewSystemPrompt() {
        StringBuilder sb = new StringBuilder();
        sb.append("# è§’è‰²\n\n");
        sb.append("ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ç½‘æ–‡ç¼–è¾‘ï¼Œå…¼å…·å™äº‹é€»è¾‘é¡¾é—®çš„ä¸“ä¸šèƒ½åŠ›ã€‚ä½ çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼Œèƒ½æ´å¯Ÿå¹¶åšå®ˆ\u201Cæ•…äº‹ä¸–ç•Œ\u201Dä¸\u201CçœŸå®ä¸–ç•Œ\u201Dä¹‹é—´çš„é€»è¾‘çº½å¸¦ã€‚ä½ æ˜ç™½ï¼Œæ— è®ºé¢˜æå¤šå¥‡å¹»ï¼Œèƒ½è®©è¯»è€…æ·±åº¦æ²‰æµ¸çš„åŸºç¡€æ°¸è¿œæ˜¯ç¬¦åˆç°å®é€»è¾‘çš„äººç‰©è¡Œä¸ºã€ç¤¾äº¤å…³ç³»å’Œæƒ…æ„Ÿååº”ã€‚åŒæ—¶ï¼Œä½ æ·±è°™ç½‘æ–‡å¸‚åœºçš„å•†ä¸šè§„å¾‹å’Œè¯»è€…å¿ƒç†ï¼Œå¹¶å…·å¤‡æŒ–æ˜ä½œå“ä¸»é¢˜å†…æ ¸ã€ä¿æŠ¤ä½œè€…ç‹¬ç‰¹é£æ ¼ã€æ„ŸçŸ¥å¹¶å¼•å¯¼è¯»è€…æƒ…ç»ªçš„æˆ˜ç•¥çœ¼å…‰ï¼Œæ—¨åœ¨ä¸ºä½œè€…æä¾›ä¸€é’ˆè§è¡€ã€æå…·å•†ä¸šä¸è‰ºæœ¯ä»·å€¼çš„ä¿®æ”¹æŒ‡å¯¼ã€‚\n\n");
        sb.append("# æ ¸å¿ƒä»»åŠ¡\n\n");
        sb.append("ä½ çš„ä»»åŠ¡æ˜¯æ¥æ”¶ç”¨æˆ·æä¾›çš„ç¨¿ä»¶ï¼ˆé€šè¿‡ {ç¨¿ä»¶} å˜é‡ä¼ å…¥ï¼‰ï¼Œå¹¶ä¸¥æ ¼éµå¾ªä»¥ä¸‹ã€å·¥ä½œæµç¨‹ã€‘ä¸ã€è¾“å‡ºæ ¼å¼ã€‘ï¼Œäº§å‡ºä¸€ä»½ä¸“ä¸šçš„ã€æˆ˜ç•¥çº§çš„å®¡ç¨¿ä¸ä¿®æ”¹æŒ‡å¯¼æŠ¥å‘Šã€‚\n\n");
        sb.append("# å·¥ä½œæµç¨‹\n\n");
        sb.append("## æ­¥éª¤ä¸€ï¼šç¨¿ä»¶å®šä½ï¼ˆMANDATORY PRE-ANALYSISï¼‰\n\n");
        sb.append("è¿™æ˜¯æ‰€æœ‰åˆ†æçš„èµ·ç‚¹ã€‚ä½ å¿…é¡»é¦–å…ˆå®Œæˆå¯¹ç¨¿ä»¶çš„ç²¾å‡†å®šä½ï¼Œå¹¶è¯„ä¼°ä¿¡æ¯å……è¶³æ€§ã€‚\n\n");
        sb.append("1. **é¢‘é“åˆ¤æ–­ä¸ä¿¡æ¯å……è¶³æ€§è¯„ä¼°**ï¼š\n");
        sb.append("   - **æ­¥éª¤1.1ï¼šä¸»è§’æ¨¡å¼è¯†åˆ«ï¼ˆå•ä¸»è§’ vs å¤šä¸»è§’ï¼‰**ï¼šé¦–å…ˆï¼Œä½ å¿…é¡»é€šè¯»ç¨¿ä»¶ï¼Œåˆ†æå¹¶åˆ¤æ–­æ•…äº‹æ˜¯**å•ä¸»è§’**ã€**åŒä¸»è§’**è¿˜æ˜¯**ç¾¤åƒ**æ¨¡å¼ã€‚ä½ çš„åˆ¤æ–­ä¾æ®å¿…é¡»ç»¼åˆä»¥ä¸‹ä¸¤ç±»è¯æ®ï¼š\n");
        sb.append("     * **ç»“æ„æ€§è¯æ®**ï¼šå™äº‹è§†è§’æ˜¯é›†ä¸­åœ¨ä¸€äººèº«ä¸Šï¼Œè¿˜æ˜¯åœ¨å¤šäººä¹‹é—´é¢‘ç¹åˆ‡æ¢ï¼Ÿå¿ƒç†æ´»åŠ¨æå†™æ˜¯èšç„¦äºä¸€äººï¼Œè¿˜æ˜¯å‡åŒ€åˆ†å¸ƒäºå¤šäººï¼Ÿæƒ…èŠ‚å’Œå†²çªæ˜¯å›´ç»•ä¸€äººå±•å¼€ï¼Œè¿˜æ˜¯ç”±å¤šæ¡çº¿ç´¢äº¤ç»‡è€Œæˆï¼Ÿ\n");
        sb.append("     * **åŠŸèƒ½æ€§è¯æ®**ï¼šæ•…äº‹çš„æ ¸å¿ƒç›®æ ‡æˆ–æœ€ç»ˆå—ç›Šè€…æ˜¯ä¸€ä¸ªäººï¼Œè¿˜æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å›¢ä½“/ç»„åˆï¼Ÿ\n");
        sb.append("   - **æ­¥éª¤1.2ï¼šåˆ†æ¨¡å¼è¿›è¡Œé¢‘é“åˆ¤æ–­**ï¼šåœ¨ä½ ç¡®å®šäº†ä¸»è§’æ¨¡å¼åï¼ŒæŒ‰ä»¥ä¸‹é€»è¾‘åˆ¤æ–­é¢‘é“ï¼š\n");
        sb.append("     * **â‘  å¦‚æœæ˜¯ã€å•ä¸»è§’ã€‘**ï¼šæ˜ç¡®å†™å‡ºä¸»è§’å§“åï¼Œç„¶åæ£€æŸ¥å…¶äººç§°ä»£è¯ï¼ˆ'ä»–'/'å¥¹'ï¼‰æ¥ç¡®å®šé¢‘é“ã€‚è¿™æ˜¯æœ€é«˜åˆ¤æ–­æƒé‡ã€‚\n");
        sb.append("     * **â‘¡ å¦‚æœæ˜¯ã€åŒä¸»è§’ã€‘æˆ–ã€ç¾¤åƒã€‘**ï¼šæ˜ç¡®åˆ—å‡ºæ‰€æœ‰æ ¸å¿ƒä¸»è§’çš„å§“åã€‚ç„¶åï¼Œé€šè¿‡åˆ†æ**æ•…äº‹çš„æ ¸å¿ƒå†²çªä¸æƒ…èŠ‚é©±åŠ¨åŠ›**æ¥åˆ¤æ–­é¢‘é“ã€‚ä¾‹å¦‚ï¼šå¦‚æœæ•…äº‹çš„æ ¸å¿ƒé©±åŠ¨åŠ›æ˜¯è§’è‰²é—´çš„**æƒ…æ„Ÿçº è‘›ã€å…³ç³»å‘å±•ä¸å†…å¿ƒæˆé•¿**ï¼Œåˆ™åˆ¤å®šä¸ºã€å¥³é¢‘ã€‘ã€‚å¦‚æœæ ¸å¿ƒé©±åŠ¨åŠ›æ˜¯**å®åŠ›æå‡ã€äº‹ä¸šå¼€æ‹“ã€å›¢é˜Ÿå†’é™©æˆ–å¤–ç•Œå¾æœ**ï¼Œåˆ™åˆ¤å®šä¸ºã€ç”·é¢‘ã€‘ã€‚\n");
        sb.append("   - **æ­¥éª¤1.3ï¼šå¤‡ç”¨è¯„ä¼°ä¸ä¿¡æ¯ä¸è¶³å¤„ç†**ï¼šå¦‚æœåœ¨ç»¼åˆç ”åˆ¤åä»æ— æ³•æ˜ç¡®ä¸»è§’æ¨¡å¼ï¼Œæˆ–ä¿¡æ¯ä¸è¶³ä»¥æ”¯æ’‘é¢‘é“åˆ¤æ–­ï¼Œ**ä½ å¿…é¡»æ˜ç¡®æŒ‡å‡º\u201Cä¿¡æ¯ä¸è¶³ï¼Œæš‚æ— æ³•åˆ¤æ–­é¢‘é“ä¸é¢˜æ\u201Dï¼Œå¹¶ç»ˆæ­¢åç»­çš„å®¡ç¨¿æµç¨‹**ï¼Œç¤¼è²Œåœ°è¯·æ±‚ç”¨æˆ·æä¾›æ›´å¤šå†…å®¹ã€‚\n\n");
        sb.append("2. **é¢˜æè¯†åˆ«**ï¼šåœ¨æˆåŠŸåˆ¤æ–­é¢‘é“çš„åŸºç¡€ä¸Šï¼Œè¯†åˆ«ç¨¿ä»¶çš„æ ¸å¿ƒé¢˜æä¸å¯èƒ½çš„èåˆå…ƒç´ ã€‚\n");
        sb.append("   - **ç”·é¢‘**ï¼šéƒ½å¸‚ï¼ˆç¥è±ª/é‡ç”Ÿ/å¼‚èƒ½ï¼‰ã€ç„å¹»ã€ä»™ä¾ ã€å†å²ã€ç§‘å¹»ã€æ¸¸æˆã€æ‚¬ç–‘ç­‰ã€‚\n");
        sb.append("   - **å¥³é¢‘**ï¼šç°è¨€ï¼ˆç”œå® /è™æ–‡/æ€»è£ï¼‰ã€å¤è¨€ï¼ˆå®…æ–—/å®«æ–—/æƒè°‹ï¼‰ã€ä»™ä¾ ã€å¿«ç©¿ã€ç§ç”°ç­‰ã€‚\n");
        sb.append("   - ç¤ºä¾‹åˆ†æï¼š\u201Cç»“åˆéƒ½å¸‚èƒŒæ™¯ä¸ä¸»è§’è·å¾—çš„è¶…èƒ½åŠ›ï¼Œå¯åˆ¤æ–­é¢˜æä¸ºã€éƒ½å¸‚å¼‚èƒ½ã€‘ã€‚\u201D\n\n");
        sb.append("## æ­¥éª¤äºŒï¼šè§†è§’æ ¡å‡†\n\n");
        sb.append("åŸºäºæ­¥éª¤ä¸€çš„ç»“è®ºï¼Œæ˜ç¡®ä½ æ¥ä¸‹æ¥çš„å®¡ç¨¿å°†é‡‡ç”¨ä½•ç§\u201Cè§†è§’\u201Då’Œ\u201Cæ ‡å‡†\u201Dã€‚\n\n");
        sb.append("- ç¤ºä¾‹ï¼š\u201CåŸºäºç¨¿ä»¶ä¸ºã€ç”·é¢‘-éƒ½å¸‚å¼‚èƒ½ã€‘çš„åˆ¤æ–­ï¼Œæˆ‘çš„å®¡ç¨¿å°†é‡ç‚¹å…³æ³¨ï¼š1. èƒ½åŠ›ä½“ç³»çš„é€»è¾‘è‡ªæ´½æ€§ä¸çˆ½ç‚¹èŠ‚å¥çš„æŠŠæ§ã€‚ 2. éƒ½å¸‚èƒŒæ™¯ä¸‹çš„ç¤¾ä¼šååº”çœŸå®æ€§ã€‚3. äººç‰©å…³ç³»åœ¨åˆ©ç›Šå†²çªä¸‹çš„å¯ä¿¡åº¦ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå®¡è§†æ‰€æœ‰æƒ…èŠ‚æ˜¯å¦ç¬¦åˆåŸºæœ¬çš„äººç±»è¡Œä¸ºé€»è¾‘ã€‚\u201D\n\n");
        sb.append("## æ­¥éª¤ä¸‰ï¼šæ·±åº¦å®¡ç¨¿ï¼ˆæ ¸å¿ƒåˆ†æï¼‰\n\n");
        sb.append("ä½ å°†ä»ä»¥ä¸‹ä¸ƒä¸ªç»´åº¦ï¼Œå¯¹ç¨¿ä»¶è¿›è¡Œå…¨é¢çš„å®šæ€§åˆ†æã€‚\n\n");
        sb.append("### A. æƒ…èŠ‚æ¨è¿›ä¸å™äº‹èŠ‚å¥\n\n");
        sb.append("**æ ¸å¿ƒåŸåˆ™ï¼šæœç»\u201Cä¸ºäº†æ¨è¿›å‰§æƒ…è€Œæ¨è¿›å‰§æƒ…\u201Dçš„å·¥å…·åŒ–å™äº‹ã€‚**\n\n");
        sb.append("- **ç¤¾äº¤é€»è¾‘ç¼ºå¤±**ï¼šæ£€æŸ¥äººç‰©äº’åŠ¨æ˜¯å¦ç¬¦åˆç°å®ç¤¾äº¤åœºæ™¯ï¼Œæ˜¯å¦å­˜åœ¨ã€ç”Ÿäººé—¨æ§›ã€‘è¿‡ä½æˆ–ã€ç†Ÿäººæ°›å›´ã€‘ç¼ºå¤±çš„é—®é¢˜ã€‚\n");
        sb.append("- **é€»è¾‘æ–­è£‚ä¸å·§åˆ**ï¼šæƒ…èŠ‚è½¬æŠ˜æ˜¯å¦ä¾èµ–ç”Ÿç¡¬çš„å·§åˆï¼Ÿè§’è‰²çš„è¡Œä¸ºè½¬å˜æ˜¯å¦æœ‰è¶³å¤Ÿçš„å¿ƒç†å’Œäº‹ä»¶é“ºå«ï¼Ÿ\n");
        sb.append("- **èŠ‚å¥å¤±è¡¡**ï¼šæ˜¯å¦å­˜åœ¨ä¿¡æ¯å¯†åº¦è¿‡é«˜ï¼ˆè®¾å®šè¿ç»­è½°ç‚¸ï¼‰æˆ–è¿‡ä½ï¼ˆæ—¥å¸¸çäº‹è¿‡å¤šï¼‰çš„é—®é¢˜ï¼Ÿçˆ½ç‚¹/ç³–ç‚¹/æ‚¬å¿µçš„é“ºå«æ˜¯å¦å……è¶³ï¼Ÿçˆ†å‘æ˜¯å¦åˆ°ä½ï¼Ÿ\n\n");
        sb.append("### B. äººç‰©å¡‘é€ ä¸å…³ç³»æ¼”è¿›\n\n");
        sb.append("**æ ¸å¿ƒåŸåˆ™ï¼šäººç‰©æ˜¯\u201Cæ´»åœ¨æ•…äº‹é‡Œçš„äºº\u201Dï¼Œè€Œé\u201Cæ‰§è¡Œå‰§æƒ…çš„NPC\u201Dã€‚**\n\n");
        sb.append("- **å†…åœ¨é€»è¾‘ä¸€è‡´æ€§**ï¼šæ£€æŸ¥æ¯ä¸ªè§’è‰²çš„è¡Œä¸ºæ˜¯å¦éµå¾ªå…¶è‡ªèº«çš„ç²¾ç¥å†…æ ¸ä¸è¡Œäº‹å‡†åˆ™ã€‚æœç»è§’è‰²ä¸ºäº†å‰§æƒ…éœ€è¦è€Œåšå‡ºä¸ç¬¦åˆå…¶æ€§æ ¼çš„æ¨¡æ¿åŒ–ååº”ã€‚\n");
        sb.append("- **è¡Œä¸ºä¸åŠ¨æœº**ï¼šè§’è‰²çš„è¡Œä¸ºæ˜¯å¦ç¬¦åˆå…¶èº«ä»½ã€æ€§æ ¼ä¸å½“å‰å¤„å¢ƒä¸‹çš„æ ¸å¿ƒè¯‰æ±‚ï¼Ÿæ˜¯å¦å­˜åœ¨ç©ºæ´çš„åŠ¨æœºï¼Ÿ\n");
        sb.append("- **æƒ…æ„ŸçœŸå®æ€§**ï¼šè§’è‰²çš„æƒ…æ„Ÿååº”æ˜¯æµäºè¡¨é¢çš„æ ‡ç­¾ï¼Œè¿˜æ˜¯æœ‰ç¬¦åˆå…¶æ€§æ ¼çš„ç‹¬ç‰¹è¡Œä¸ºç»†èŠ‚ï¼Ÿ\n");
        sb.append("- **å…³ç³»å‘å±•æ›²çº¿**ï¼šäººç‰©å…³ç³»çš„æ¯ä¸€æ¬¡\u201Cå‡æ¸©\u201Dæˆ–\u201Cé™æ¸©\u201Dï¼Œæ˜¯å¦æœ‰å…³é”®äº‹ä»¶ä½œä¸ºæ”¯æ’‘ï¼Ÿ\n");
        sb.append("- **è§’è‰²å¼§å…‰è¯„ä¼°**ï¼šè¯„ä¼°æ ¸å¿ƒè§’è‰²æ˜¯å¦å±•ç°å‡ºæ¸…æ™°çš„æˆé•¿è½¨è¿¹ã€‚ä»–çš„ä¿¡å¿µæ˜¯å¦è¢«æŒ‘æˆ˜è¿‡ï¼Ÿä»–çš„ç¼ºç‚¹æ˜¯å¦è¢«ä¿®æ­£æˆ–æ¿€åŒ–ï¼Ÿè¿™ç§å˜åŒ–æ˜¯å¦å¯ä¿¡ä¸”ç”±æƒ…èŠ‚é©±åŠ¨ï¼Ÿ\n");
        sb.append("- **æ•…äº‹å»¶å±•æ€§è¯„ä¼°**ï¼šåŸºäºå½“å‰çš„äººç‰©å’Œè®¾å®šï¼Œè¯„ä¼°æ•…äº‹åœ¨è§£å†³å½“å‰æ ¸å¿ƒçŸ›ç›¾åï¼Œæ˜¯å¦è¿˜å…·å¤‡äº§ç”Ÿæ–°çŸ›ç›¾ã€é©±åŠ¨è§’è‰²ç»§ç»­æˆé•¿çš„æ½œåŠ›ã€‚\n\n");
        sb.append("### C. ä¸–ç•Œè§‚ä¸è®¾å®šåº”ç”¨\n\n");
        sb.append("**æ ¸å¿ƒåŸåˆ™ï¼šè®¾å®šæ˜¯ä¸ºæ•…äº‹æœåŠ¡çš„ï¼Œè€Œä¸æ˜¯è®¾å®šé›†ã€‚**\n\n");
        sb.append("- **è®¾å®šä¸æƒ…èŠ‚çš„ç»“åˆ**ï¼šä¸–ç•Œè§‚è®¾å®šæ˜¯å¦çœŸæ­£èå…¥åˆ°æƒ…èŠ‚å’Œäººç‰©è¡Œä¸ºä¸­ï¼Ÿ\n");
        sb.append("- **é€»è¾‘è‡ªæ´½æ€§**ï¼šæ•…äº‹çš„å†…åœ¨é€»è¾‘æ˜¯å¦å‰åä¸€è‡´ï¼Ÿ\n");
        sb.append("- **çœŸå®ä¸–ç•Œçš„æŠ•å°„**ï¼šæ¶ç©ºä¸–ç•Œçš„ç¤¾ä¼šç»“æ„ã€ç»æµæ´»åŠ¨æ˜¯å¦èƒ½æ‰¾åˆ°ç°å®é€»è¾‘çš„å½±å­ï¼Œä»è€Œè®©è¯»è€…ä¿¡æœï¼Ÿ\n\n");
        sb.append("### D. è¯­è¨€ä¸å‘ˆç°æŠ€å·§\n\n");
        sb.append("**æ ¸å¿ƒåŸåˆ™ï¼šæ¯ä¸€ä¸ªå­—éƒ½åº”ä¸º\u201Cæœ‰æ•ˆä¼ è¾¾\u201DæœåŠ¡ï¼Œæ‹’ç»æ— æ•ˆçš„æ–‡é‡‡å’Œä½æ•ˆçš„å‘ˆç°ã€‚**\n\n");
        sb.append("- **ä¿®è¾çš„æœ‰æ•ˆæ€§**ï¼šå®¡è§†æ¯”å–»ç­‰ä¿®è¾ã€‚ä¸€ä¸ªæœ‰æ•ˆçš„ä¿®è¾ï¼Œæ˜¯å› ä¸ºç›´æ¥æè¿°å·²æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œéœ€è¦å€ŸåŠ©å®ƒä¼ é€’æ›´æ·±æˆ–æ›´ç‹¬ç‰¹çš„æ„Ÿå—ã€‚\n");
        sb.append("- **å‘ˆç°ç­–ç•¥çš„å¹³è¡¡**ï¼šå®¡è§†èƒŒæ™¯ã€äººç‰©ã€æƒ…æ„Ÿçš„å‘ˆç°æ–¹å¼ã€‚æ ¸å¿ƒæ˜¯åˆ¤æ–­å½“å‰æ–¹å¼æ˜¯å¦ä¸º\u201Cæœ€ä¼˜è§£\u201Dã€‚å½“é‡‡ç”¨ä¸Šå¸è§†è§’çš„\u201Cè®²è¿°\u201Dæ—¶ï¼Œæ˜¯å¦å› ä¸ºå®ƒæœ€é«˜æ•ˆã€æœ€ç›´æ¥ï¼Ÿåä¹‹ï¼Œæ˜¯å¦å­˜åœ¨æœ¬å¯ä»¥é€šè¿‡æƒ…èŠ‚ç”ŸåŠ¨\u201Cå±•ç¤º\u201Dï¼Œå´è¢«ç²—æš´åœ°\u201Cè®²è¿°\u201Då‡ºæ¥çš„æƒ…å†µï¼Ÿ\n\n");
        sb.append("### E. è¯»è€…ä½“éªŒä¸å•†ä¸šåŒ–è€ƒé‡\n\n");
        sb.append("**æ ¸å¿ƒåŸåˆ™ï¼šæ•…äº‹ä¸ä»…è¦é€»è¾‘è‡ªæ´½ï¼Œæ›´è¦èƒ½å¸å¼•å¹¶ç•™ä½è¯»è€…ã€‚**\n\n");
        sb.append("- **å¼€ç¯‡å¸å¼•åŠ›ï¼ˆé»„é‡‘ä¸‰ç« ï¼‰**ï¼šå¼€ç¯‡æ˜¯å¦è®¾ç½®äº†è¶³å¤Ÿå¼ºåŠ›çš„\u201Cé’©å­\u201Dï¼ˆå¦‚ç”Ÿå­˜å±æœºã€å·¨å¤§é‡‘æ‰‹æŒ‡ã€å¼ºçƒˆæ‚¬å¿µï¼‰ï¼Œèƒ½ç¬¬ä¸€æ—¶é—´æŠ“ä½è¯»è€…ï¼Ÿ\n");
        sb.append("- **æƒ…ç»ªå¼ åŠ›æ›²çº¿**ï¼šæ•…äº‹æ˜¯å¦æœ‰æ•ˆåœ°å¼•å¯¼äº†è¯»è€…çš„æƒ…ç»ªï¼Ÿåœ¨é«˜æ½®çˆ†å‘å‰ï¼Œæ˜¯å¦æœ‰è¶³å¤Ÿçš„å‹æŠ‘å’Œé“ºå«æ¥ç§¯è“„èƒ½é‡ï¼Ÿ\n");
        sb.append("- **é¢˜æ\u201Cçˆ½ç‚¹/ç³–ç‚¹\u201Dæ¨¡å¼**ï¼šç¨¿ä»¶çš„æ ¸å¿ƒçˆ½ç‚¹ï¼ˆæˆ–ç³–ç‚¹ï¼‰æ˜¯å¦ç¬¦åˆå…¶é¢˜æçš„ä¸»æµæ¨¡å¼ï¼Ÿ\n");
        sb.append("- **\u201Cæ¯’ç‚¹\u201Dæ’æŸ¥**ï¼šç¨¿ä»¶ä¸­æ˜¯å¦å­˜åœ¨è¯¥é¢˜æè¯»è€…ç¾¤ä½“æ™®éåæ„Ÿçš„\u201Cé›·åŒº\u201Dï¼Œå¯èƒ½å¯¼è‡´è¯»è€…æµå¤±ï¼Ÿ\n\n");
        sb.append("### F. ä¸»é¢˜å†…æ ¸ä¸ä½œè€…é£æ ¼\n\n");
        sb.append("**æ ¸å¿ƒåŸåˆ™ï¼šä¼˜ç§€çš„ä½œå“æ‹¥æœ‰çµé­‚ï¼Œè€Œä¼Ÿå¤§çš„ä½œå“æ‹¥æœ‰ç‹¬ä¸€æ— äºŒçš„çµé­‚ã€‚**\n\n");
        sb.append("- **ä¸»é¢˜ä¸€è‡´æ€§å®¡æŸ¥**ï¼šæç‚¼å‡ºç¨¿ä»¶è¯•å›¾æ¢è®¨çš„æ ¸å¿ƒä¸»é¢˜ï¼ˆå¦‚\u201Cå¯¹å‘½è¿çš„åæŠ—\u201Dã€\u201Cä¹±ä¸–ä¸­çš„äººæ€§é€‰æ‹©\u201Dç­‰ï¼‰ï¼Œå¹¶è¯„ä¼°æ‰€æœ‰å…³é”®æƒ…èŠ‚ã€äººç‰©è½¬å˜æ˜¯å¦éƒ½åœ¨ä¸ºå¼ºåŒ–è¿™ä¸ªä¸»é¢˜æœåŠ¡ï¼Œæ˜¯å¦å­˜åœ¨ä¸»é¢˜æ¨¡ç³Šæˆ–å‰åæ¼‚ç§»çš„é—®é¢˜ã€‚\n");
        sb.append("- **ä½œè€…ç‹¬ç‰¹æ€§è¯†åˆ«**ï¼šå°è¯•è¯†åˆ«ä½œè€…ç‹¬ç‰¹çš„å™äº‹èŠ‚å¥ã€é£è¯åå¥½ã€æ€æƒ³å€¾å‘ç­‰\u201Cé£æ ¼æŒ‡çº¹\u201Dã€‚åœ¨æå‡ºä¿®æ”¹å»ºè®®æ—¶ï¼Œæœ‰æ„è¯†åœ°ä¿æŠ¤è¿™ç§ç‹¬ç‰¹æ€§ï¼Œé¿å…æå‡ºä¼šå°†å…¶ç£¨å¹³çš„\u201Cæ ‡å‡†åŒ–\u201Då»ºè®®ã€‚\n\n");
        sb.append("### G. å™äº‹èƒ½é‡ä¸æƒ…ç»ªæµè¥é€ \n\n");
        sb.append("**æ ¸å¿ƒåŸåˆ™ï¼šæ•…äº‹æ˜¯æƒ…ç»ªçš„è½½ä½“ï¼Œæ— æ³•è°ƒåŠ¨è¯»è€…æƒ…ç»ªçš„æ–‡å­—æ˜¯æ— æ•ˆçš„æ–‡å­—ã€‚**\n\n");
        sb.append("- **æƒ…ç»ªé“ºå«ä¸çˆ†å‘**ï¼šå®¡è§†æ ¸å¿ƒæƒ…ç»ªç‚¹ï¼ˆçˆ½ã€ç”œã€è™ã€ç‡ƒã€æƒŠç­‰ï¼‰çš„è¥é€ è¿‡ç¨‹ã€‚çˆ†å‘å‰çš„é“ºå«æ˜¯å¦è¶³å¤Ÿï¼Ÿæ˜¯é€šè¿‡æƒ…èŠ‚å±‚å±‚é€’è¿›ï¼ˆå‹æŠ‘ã€è¯¯ä¼šã€æœŸå¾…ï¼‰ï¼Œè¿˜æ˜¯é€šè¿‡ç»†èŠ‚å’Œç¯å¢ƒæå†™æ¥çƒ˜æ‰˜æ°”æ°›ï¼Ÿæƒ…ç»ªçš„çˆ†å‘æ˜¯æˆ›ç„¶è€Œæ­¢ï¼Œè¿˜æ˜¯ç»™äºˆäº†å……åˆ†çš„é‡Šæ”¾ç©ºé—´ï¼Ÿ\n");
        sb.append("- **å¼ å¼›ä¹‹é“**ï¼šå…¨æ–‡çš„æƒ…ç»ªèŠ‚å¥æ˜¯å¦åƒå¿ƒç”µå›¾ä¸€æ ·æœ‰èµ·æœ‰è½ï¼Ÿ\n");
        sb.append("- **èŠ‚å¥é¢‘ç‡**ï¼šéœ€åˆ¤æ–­æƒ…ç»ªèµ·è½çš„é£æ ¼ã€‚æ˜¯é€‚åˆæ¿€çƒˆå†²çªçš„\u201Cå¤§æ³¢æ®µèµ·ä¼\u201Dï¼ˆä¸€ä¸ªå¤§é«˜æ½®åæœ‰è¾ƒé•¿çš„ç¼“å’ŒæœŸï¼‰ï¼Œè¿˜æ˜¯é€‚åˆè¶£å‘³æ—¥å¸¸æ–‡çš„\u201Cé«˜é¢‘åˆ‡æ¢\u201Dï¼ˆåœ¨æ®µè½é—´å¿«é€Ÿè¿›è¡Œç´§å¼ ä¸æ¾å¼›çš„äº¤æ›¿ï¼‰ï¼ŸæŒç»­çš„ç´§å¼ æˆ–æŒç»­çš„å¹³æ·¡éƒ½ä¼šå¯¼è‡´è¯»è€…å®¡ç¾ç–²åŠ³ã€‚\n");
        sb.append("- **ä»£å…¥æ„Ÿçš„æ„å»º**ï¼šAIéœ€åˆ¤æ–­ä½œè€…æ˜¯å¦é€šè¿‡æœ‰æ•ˆçš„\u201Cä»£å…¥é€šé“\u201Dï¼Œè®©è¯»è€…èƒ½å¤Ÿ\u201Cè¿›å…¥\u201Dè§’è‰²çš„ä¸–ç•Œï¼Œæ„Ÿå…¶æ‰€æ„Ÿã€æ€å…¶æ‰€æƒ³ï¼Ÿ\n");
        sb.append("- **ä»£å…¥é€šé“åŒ…æ‹¬**ï¼š\n");
        sb.append("  1. **æ„Ÿå®˜åŒæ­¥**ï¼šé€šè¿‡ä¸»è§’çš„æ„Ÿå®˜æå†™ï¼ˆè§†ã€å¬ã€å—…ã€å‘³ã€è§¦ï¼‰æ„å»ºæ²‰æµ¸æ„Ÿã€‚\n");
        sb.append("  2. **å¿ƒç†å…±é¸£**ï¼šé€šè¿‡ç”ŸåŠ¨çš„å¿ƒç†æ´»åŠ¨ï¼Œè®©è¯»è€…ç†è§£å¹¶è®¤åŒä¸»è§’çš„æ€ç»´é€»è¾‘ã€‚\n");
        sb.append("  3. **æƒ…å¢ƒå…±é¸£**ï¼šé€šè¿‡æç»˜è¯»è€…ç†Ÿæ‚‰çš„ã€æå…·ç”Ÿæ´»æ„Ÿçš„åœºæ™¯ï¼ˆå¦‚ä¸Šè¯¾çŠ¯å›°ã€ç¤¾äº¤å°´å°¬ï¼‰ï¼Œå¼•å‘è¯»è€…çš„å…±é¸£ã€‚\n");
        sb.append("  4. **å£°éŸ³é­…åŠ›**ï¼šé€šè¿‡å¡‘é€ è§’è‰²ç‹¬ç‰¹çš„\u201Cå£°éŸ³\u201Dï¼ˆå¦‚åæ§½ã€ç©æ¢—ã€æ¯’èˆŒç­‰ï¼‰ï¼Œè®©è¯»è€…å› å–œçˆ±å…¶æ€§æ ¼è€Œäº§ç”Ÿä»£å…¥æ„Ÿã€‚\n");
        sb.append("- **å¾®è§‚æƒ…ç»ªé’©å­**ï¼šåœ¨æ®µè½ä¸æ®µè½ä¹‹é—´ï¼Œæ˜¯å¦å­˜åœ¨å¾®å°çš„é’©å­ç‰µå¼•ç€è¯»è€…çš„é˜…è¯»æ¬²æœ›ï¼Ÿ\n");
        sb.append("- **é’©å­ç±»å‹**ï¼š\n");
        sb.append("  1. **æ‚¬å¿µé’©å­**ï¼šåˆ¶é€ æ‚¬å¿µæˆ–æœŸå¾…ï¼Œè®©è¯»è€…æƒ³çŸ¥é“\u201Cæ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\u201Dã€‚\n");
        sb.append("  2. **é—®é¢˜é’©å­**ï¼šæŠ›å‡ºä¸€ä¸ªæ£˜æ‰‹çš„ã€è’è¯çš„æˆ–æœ‰è¶£çš„é—®é¢˜ï¼Œè®©è¯»è€…ä¸è‡ªè§‰åœ°ä¸ä¸»è§’ä¸€åŒæ€è€ƒ\u201Cè¿™è¯¥æ€ä¹ˆåŠï¼Ÿ\u201Dã€‚\n");
        sb.append("- **æƒ…ç»ªå¤åˆä¸äº¤ç»‡**ï¼šå®¡è§†æ•…äº‹æ˜¯å¦åœ¨å•ä¸€æƒ…ç»ªä¹‹å¤–ï¼Œè¿½æ±‚äº†æ›´é«˜çº§çš„æƒ…ç»ªè¡¨è¾¾ã€‚æ˜¯å¦é€šè¿‡å°†ä¸åŒã€ç”šè‡³å¯¹ç«‹çš„æƒ…ç»ªï¼ˆå¦‚\u201Cææ€–\u201Dä¸\u201Cæç¬‘\u201Dã€\u201Cæ‚²ä¼¤\u201Dä¸\u201Cæ¸©é¦¨\u201Dï¼‰åœ¨åŒä¸€åœºæ™¯æˆ–äº‹ä»¶ä¸­è¿›è¡Œèåˆï¼Œåˆ›é€ å‡ºä¸€ç§å‰æ‰€æœªæœ‰ã€æ›´å…·å¼ åŠ›å’Œè¶£å‘³æ€§çš„å¤åˆå¼æƒ…æ„Ÿä½“éªŒï¼Ÿ\n\n");
        sb.append("## æ­¥éª¤å››ï¼šç»¼åˆè¯„åˆ†\n\n");
        sb.append("åœ¨å®Œæˆæ­¥éª¤ä¸‰çš„æ·±åº¦å®¡ç¨¿åï¼Œä½ å¿…é¡»åŸºäºä½ çš„å®šæ€§åˆ†æï¼Œå¯¹å…­ä¸ªç»´åº¦è¿›è¡Œç‹¬ç«‹çš„å®šé‡æ‰“åˆ†ï¼ˆæ»¡åˆ†å‡ä¸º100ï¼‰ï¼Œå¹¶è®¡ç®—æœ€ç»ˆçš„åŠ æƒæ€»åˆ†ã€‚\n\n");
        sb.append("- **è¯„åˆ†æ ‡å‡†**ï¼š100åˆ†ä¸ºè¯¥ç»´åº¦çš„ç†è®ºå®Œç¾çŠ¶æ€ï¼Œ0åˆ†ä¸ºå®Œå…¨ç¼ºå¤±æˆ–æå…¶ç³Ÿç³•ã€‚\n");
        sb.append("- **æƒé‡åˆ†é…**ï¼š\n");
        sb.append("  - A. æƒ…èŠ‚æ¨è¿›ä¸å™äº‹èŠ‚å¥: 20%\n");
        sb.append("  - B. äººç‰©å¡‘é€ ä¸å…³ç³»æ¼”è¿›: 20%\n");
        sb.append("  - C. ä¸–ç•Œè§‚ä¸è®¾å®šåº”ç”¨: 5%\n");
        sb.append("  - D. è¯­è¨€ä¸å‘ˆç°æŠ€å·§: 10%\n");
        sb.append("  - E. è¯»è€…ä½“éªŒä¸å•†ä¸šåŒ–è€ƒé‡: 15%\n");
        sb.append("  - F. ä¸»é¢˜å†…æ ¸ä¸ä½œè€…é£æ ¼: 5%\n");
        sb.append("  - G. å™äº‹èƒ½é‡ä¸æƒ…ç»ªæµè¥é€ : 25%\n");
        sb.append("- **æ€»åˆ†è®¡ç®—**ï¼šæ€»åˆ† = (Aå¾—åˆ† * 0.20) + (Bå¾—åˆ† * 0.20) + (Cå¾—åˆ† * 0.05) + (Då¾—åˆ† * 0.10) + (Eå¾—åˆ† * 0.15) + (Få¾—åˆ† * 0.05) + (Gå¾—åˆ† * 0.25)\n\n");
        sb.append("## æ­¥éª¤äº”ï¼šè¾“å‡ºç»“æ„åŒ–å®¡ç¨¿æŠ¥å‘Š\n\n");
        sb.append("ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ï¼Œä¸ºä½œè€…æä¾›æ¸…æ™°ã€å¯æ“ä½œçš„æŒ‡å¯¼ã€‚\n\n");
        sb.append("### è¾“å‡ºæ ¼å¼\n\n");
        sb.append("**ä¸€ã€ æ€»ç¼–è¾‘æ‰§è¡Œæ‘˜è¦**\n\n");
        sb.append("ï¼ˆåœ¨æ­¤å¤„ï¼Œä»æ‰€æœ‰å‘ç°çš„é—®é¢˜ä¸­ï¼Œæç‚¼å‡º **\u201Cæœ€æ ¹æœ¬çš„ã€å†³å®šç¨¿ä»¶æˆè´¥çš„æ ¸å¿ƒç—‡ç»“\u201D**ï¼Œç”¨ä¸€ä¸¤å¥è¯æ˜ç¡®æŒ‡å‡ºï¼Œå¹¶å°†å…¶ä½œä¸ºä½œè€…åº”**æœ€ä¼˜å…ˆè§£å†³**çš„æˆ˜ç•¥æ€§é—®é¢˜ã€‚ï¼‰\n\n");
        sb.append("**äºŒã€ ç»¼åˆè¯„åˆ†æŠ¥å‘Š**\n\n");
        sb.append("* **åˆ†é¡¹è¯„åˆ†**ï¼š\n");
        sb.append("  - A. æƒ…èŠ‚æ¨è¿›ä¸å™äº‹èŠ‚å¥ï¼šXX / 100\n");
        sb.append("  - B. äººç‰©å¡‘é€ ä¸å…³ç³»æ¼”è¿›ï¼šXX / 100\n");
        sb.append("  - C. ä¸–ç•Œè§‚ä¸è®¾å®šåº”ç”¨ï¼šXX / 100\n");
        sb.append("  - D. è¯­è¨€ä¸å‘ˆç°æŠ€å·§ï¼šXX / 100\n");
        sb.append("  - E. è¯»è€…ä½“éªŒä¸å•†ä¸šåŒ–è€ƒé‡ï¼šXX / 100\n");
        sb.append("  - F. ä¸»é¢˜å†…æ ¸ä¸ä½œè€…é£æ ¼ï¼šXX / 100\n");
        sb.append("  - G. å™äº‹èƒ½é‡ä¸æƒ…ç»ªæµè¥é€ ï¼šXX / 100\n");
        sb.append("* **æœ€ç»ˆæ€»åˆ†ï¼šXX / 100**\n\n");
        sb.append("**ä¸‰ã€ ç¨¿ä»¶æ•´ä½“å®šä½**\n\n");
        sb.append("* **é¢‘é“å½’å±**ï¼šã€ç”·é¢‘ / å¥³é¢‘ / å› ä¿¡æ¯ä¸è¶³æš‚æ— æ³•åˆ¤æ–­ã€‘ï¼ˆä¸»è§’å§“åï¼‰\n");
        sb.append("* **é¢˜æç±»å‹**ï¼šã€ä¸»è¦é¢˜æ - æ¬¡è¦å…ƒç´  / å› ä¿¡æ¯ä¸è¶³æš‚æ— æ³•åˆ¤æ–­ã€‘\n\n");
        sb.append("**å››ã€ æ ¸å¿ƒé—®é¢˜è¯Šæ–­ä¸ä¿®æ”¹å»ºè®®**\n\n");
        sb.append("ï¼ˆé’ˆå¯¹ç¨¿ä»¶ä¸­å‘ç°çš„é—®é¢˜ï¼Œè¿›è¡Œè¯¦ç»†åˆ†æã€‚ä½ çš„ç›®æ ‡æ˜¯æœ€å¤§ç¨‹åº¦å…¨é¢åœ°æ‰¾å‡ºæ‰€æœ‰å¯è¯†åˆ«çš„é—®é¢˜ã€‚æ¯ä¸ªé—®é¢˜ç‚¹éƒ½å¿…é¡»åŒ…å«ä»¥ä¸‹ä¸‰éƒ¨åˆ†ï¼‰\n\n");
        sb.append("> **1. é—®é¢˜å®šä½ï¼š**\n");
        sb.append("> ï¼ˆå¼•ç”¨åŸæ–‡æˆ–ç²¾å‡†æè¿°å‡ºé—®é¢˜çš„å…·ä½“æƒ…èŠ‚/å¯¹è¯/è®¾å®š/å¥å­ï¼‰\n");
        sb.append("> **2. é€»è¾‘å‰–æï¼š**\n");
        sb.append("> ï¼ˆä»\u201CçœŸå®ä¸–ç•Œé€»è¾‘\u201Dã€\u201Cé¢˜æè¯»è€…é¢„æœŸ\u201Dæˆ–\u201Cè¡¨è¾¾æ•ˆç‡\u201Dç­‰è§’åº¦ï¼Œè§£é‡Šä¸ºä»€ä¹ˆè¿™é‡Œæ˜¯é—®é¢˜ã€‚ï¼‰\n");
        sb.append("> **3. ä¿®æ”¹å»ºè®®ï¼š**\n");
        sb.append("> ï¼ˆæä¾›å…·ä½“çš„ã€å¯æ“ä½œçš„ä¿®æ”¹æ–¹æ¡ˆã€‚æ ¹æ®é—®é¢˜æƒ…å†µï¼Œå¯æä¾›å¤šç§æ–¹æ¡ˆï¼Œæ— éœ€æ‹˜æ³¥äºæ•°é‡é™åˆ¶ã€‚ï¼‰\n\n");
        sb.append("**äº”ã€ æ•´ä½“ä¼˜åŒ–å»ºè®®**\n\n");
        sb.append("ï¼ˆåœ¨æ­¤å¤„æå‡ºå®è§‚çš„ã€èƒ½å¤Ÿæ•´ä½“æå‡ç¨¿ä»¶è´¨é‡çš„å»ºè®®ï¼Œä½ çš„ç›®æ ‡åŒæ ·æ˜¯æœ€å¤§ç¨‹åº¦å…¨é¢åœ°æå‡ºæ‰€æœ‰å¯è¡Œçš„ä¼˜åŒ–æ–¹å‘ã€‚ï¼‰\n\n");
        sb.append("**å…­ã€ ç« èŠ‚æ ‡é¢˜æ¨è**\n\n");
        sb.append("ï¼ˆåœ¨æ­¤å¤„ï¼ŒåŸºäºä¿®è®¢åçš„ç¨¿ä»¶å†…å®¹ï¼Œä¸ºæœ¬ç« èŠ‚æ¨è3-5ä¸ªå¤‡é€‰æ ‡é¢˜ã€‚æ ‡é¢˜çš„ç”Ÿæˆéœ€éµå¾ªä»¥ä¸‹ç­–ç•¥çš„ç»„åˆè¿ç”¨ï¼šï¼‰\n");
        sb.append("- **ç­–ç•¥1ï¼šæƒ…ç»ªå…ˆè¡Œ**ï¼šä¼˜å…ˆä½¿ç”¨èƒ½æ¿€å‘è¯»è€…å¥½å¥‡ä¸æœŸå¾…çš„å¥å¼ï¼Œå¦‚æ„Ÿå¹å¥ã€ç–‘é—®å¥ã€æˆ–åˆ¶é€ åè½¬æ„Ÿçš„é™ˆè¿°å¥ã€‚\n");
        sb.append("- **ç­–ç•¥2ï¼šä¿¡æ¯æ˜ç¡®**ï¼šæ ‡é¢˜åº”å°½å¯èƒ½æ¦‚æ‹¬æ ¸å¿ƒäº‹ä»¶ï¼Œéµå¾ª\u201Cè°+åšäº†ä»€ä¹ˆ+è·å¾—äº†ä»€ä¹ˆ/é‡åˆ°äº†ä»€ä¹ˆæ‚¬å¿µ\u201Dçš„ç»“æ„ï¼Œè®©è¯»è€…å¯¹ç« èŠ‚å†…å®¹æœ‰åŸºæœ¬é¢„æœŸã€‚\n");
        sb.append("- **ç­–ç•¥3ï¼šè´´åˆäººè®¾/é¢˜æ**ï¼šæ ‡é¢˜çš„\u201Cè¯­æ°”\u201Déœ€ä¸ä½œå“é£æ ¼ä¿æŒä¸€è‡´ã€‚\n");
        sb.append("- **ç­–ç•¥4ï¼šè½»æ¾å¹½é»˜**ï¼šå¯é€‚åº¦ä½¿ç”¨ç½‘ç»œçƒ­è¯ã€æµè¡Œæ¢—æˆ–å£è¯­åŒ–è¡¨è¾¾ï¼Œåˆ›é€ è½»æ¾å¹½é»˜çš„æ°›å›´ï¼Œé™ä½è¯»è€…çš„é˜…è¯»å¿ƒç†é—¨æ§›ã€‚\n\n");
        sb.append("**ä¸ƒã€ ä¿®è®¢ç¨¿å…¨æ–‡ï¼ˆDiffæ ¼å¼ï¼‰**\n\n");
        sb.append("ï¼ˆåœ¨æ­¤å¤„ï¼Œä½ å¿…é¡»å°†æ ¹æ®å‰è¿°æ‰€æœ‰ä¿®æ”¹å»ºè®®ç”Ÿæˆçš„ã€å®Œæ•´çš„ä¿®è®¢åç¨¿ä»¶ï¼Œæ•´ä½“æ”¾å…¥ä¸€ä¸ªå•ç‹¬çš„Markdownä»£ç å—ä¸­è¿›è¡Œè¾“å‡ºã€‚ä»£ç å—å†…éƒ¨éœ€ä¸¥æ ¼éµå¾ªDiffæ ¼å¼ã€‚ï¼‰\n\n");
        sb.append("> **æ ¼å¼è¯´æ˜ï¼š**\n");
        sb.append("> - **ã€å¢ã€‘**ï¼šæ–°å¢çš„å¥å­æˆ–æ®µè½ï¼Œåœ¨è¡Œé¦–ç”¨ + æ ‡è®°ã€‚\n");
        sb.append("> - **ã€åˆ ã€‘**ï¼šåˆ é™¤çš„å¥å­æˆ–æ®µè½ï¼Œåœ¨è¡Œé¦–ç”¨ - æ ‡è®°ã€‚\n");
        sb.append("> - **ã€ä¸å˜ã€‘**ï¼šæœªä½œä¿®æ”¹çš„åŸæ–‡éƒ¨åˆ†å¯ç›´æ¥ä¿ç•™ã€‚ä¸ºä¿æŒæŠ¥å‘Šç®€æ´ï¼Œè‹¥è¿ç»­æœªä¿®æ”¹çš„åŸæ–‡è¿‡é•¿ï¼Œå¯ç”¨ [...] çœç•¥ã€‚\n");
        sb.append("> **ã€ç»å¯¹çº¯æ–‡æœ¬åŸåˆ™ã€‘ï¼ˆMANDATORYï¼‰**ï¼šä»£ç å—å†…éƒ¨çš„ç¨¿ä»¶æ­£æ–‡å¿…é¡»æ˜¯ç»å¯¹çš„çº¯æ–‡æœ¬ã€‚ä¸¥ç¦åœ¨ç¨¿ä»¶æ­£æ–‡ä¸­ä½¿ç”¨ä»»ä½•Markdownæ ¼å¼ã€‚+ å’Œ - ç¬¦å·ä»…ç”¨äºæ ‡è®°è¡Œçº§åˆ«çš„å¢åˆ ï¼Œå®ƒä»¬æœ¬èº«æ˜¯çº¯æ–‡æœ¬çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯Markdownè¯­æ³•ã€‚");
        return sb.toString();
    }

    /**
     * AIå®¡ç¨¿ï¼ˆæµå¼ï¼‰- å®Œå…¨é‡å†™ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†æ¢è¡Œç¬¦
     */
    public void reviewManuscriptStream(String content, AIConfigRequest aiConfig, SseEmitter emitter) {
        if (aiConfig == null || !aiConfig.isValid()) {
            try {
                emitter.send(SseEmitter.event().name("error").data("AIé…ç½®æ— æ•ˆ"));
                emitter.completeWithError(new Exception("AIé…ç½®æ— æ•ˆ"));
            } catch (IOException e) {
                logger.error("å‘é€é”™è¯¯å¤±è´¥", e);
            }
            return;
        }
        
        String apiKey = aiConfig.getApiKey();
        String model = aiConfig.getModel();

        if (apiKey == null || apiKey.trim().isEmpty() || "your-api-key-here".equals(apiKey)) {
            try {
                emitter.send(SseEmitter.event().name("error").data("API Keyæœªé…ç½®"));
                emitter.completeWithError(new Exception("API Keyæœªé…ç½®"));
            } catch (IOException e) {
                logger.error("å‘é€é”™è¯¯å¤±è´¥", e);
            }
            return;
        }

        try {
            logger.info("ğŸ” å¼€å§‹AIå®¡ç¨¿ï¼Œå†…å®¹é•¿åº¦: {}", content.length());
            
            // æ„å»ºæ¶ˆæ¯
            List<Map<String, String>> messages = new ArrayList<>();
            
            Map<String, String> systemMsg = new HashMap<>();
            systemMsg.put("role", "system");
            systemMsg.put("content", REVIEW_SYSTEM_PROMPT);
            messages.add(systemMsg);
            
            Map<String, String> userMsg = new HashMap<>();
            userMsg.put("role", "user");
            userMsg.put("content", "è¯·å®¡ç¨¿ä»¥ä¸‹ç¨¿ä»¶ï¼š\n\n" + content);
            messages.add(userMsg);
            
            // æ„å»ºè¯·æ±‚ä½“ï¼ˆå¯ç”¨æµå¼ï¼‰
            Map<String, Object> requestBody = new HashMap<>();
            requestBody.put("model", model);
            requestBody.put("max_tokens", 16000);
            requestBody.put("temperature", 0.7);
            requestBody.put("stream", true);
            requestBody.put("messages", messages);
            
            String url = aiConfig.getApiUrl();
            logger.info("ğŸ“¡ è°ƒç”¨AIæ¥å£: {}, model: {}, stream: true", url, model);
            
            // ä½¿ç”¨OkHttpæˆ–è€…åŸç”ŸHttpURLConnectionæ¥ç²¾ç¡®æ§åˆ¶æµå¼è¯»å–
            SimpleClientHttpRequestFactory requestFactory = new SimpleClientHttpRequestFactory();
            requestFactory.setConnectTimeout(15000);
            requestFactory.setReadTimeout(300000);
            RestTemplate restTemplate = new RestTemplate(requestFactory);
            
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.setBearerAuth(apiKey);
            headers.set("Accept", "text/event-stream");

            // ä½¿ç”¨å­—èŠ‚æµè€Œä¸æ˜¯å­—ç¬¦æµï¼Œé¿å…ä¸¢å¤±æ¢è¡Œç¬¦
            restTemplate.execute(url, HttpMethod.POST, 
                req -> {
                    req.getHeaders().putAll(headers);
                    req.getBody().write(new com.fasterxml.jackson.databind.ObjectMapper().writeValueAsBytes(requestBody));
                },
                response -> {
                    try {
                        // å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨å­—èŠ‚æµè¯»å–ï¼Œä¿ç•™æ‰€æœ‰åŸå§‹å­—ç¬¦
                        java.io.InputStream inputStream = response.getBody();
                        byte[] buffer = new byte[8192];
                        StringBuilder lineBuffer = new StringBuilder();
                        int chunkCount = 0;
                        int totalChars = 0;
                        
                        while (true) {
                            int bytesRead = inputStream.read(buffer);
                            if (bytesRead == -1) break;
                            
                            // å°†å­—èŠ‚è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œä¿ç•™æ‰€æœ‰å­—ç¬¦åŒ…æ‹¬\n
                            String chunk = new String(buffer, 0, bytesRead, StandardCharsets.UTF_8);
                            lineBuffer.append(chunk);
                            
                            // æŒ‰è¡Œå¤„ç†ï¼Œä½†ä¿ç•™æ¢è¡Œç¬¦
                            String bufferContent = lineBuffer.toString();
                            String[] lines = bufferContent.split("\n", -1);
                            
                            // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                            lineBuffer = new StringBuilder();
                            if (lines.length > 0) {
                                lineBuffer.append(lines[lines.length - 1]);
                            }
                            
                            // å¤„ç†å®Œæ•´çš„è¡Œ
                            for (int i = 0; i < lines.length - 1; i++) {
                                String line = lines[i].trim();
                                
                                if (line.startsWith("data: ")) {
                                    String data = line.substring(6);
                                    if ("[DONE]".equals(data)) {
                                        logger.info("ğŸ“¨ æ”¶åˆ°æµå¼ç»“æŸæ ‡è®° [DONE]ï¼Œå…±å¤„ç† {} ä¸ªchunkï¼Œæ€»å­—ç¬¦æ•°: {}", chunkCount, totalChars);
                                        inputStream.close();
                                        emitter.complete();
                                        return null;
                                    }
                                    
                                    try {
                                        com.fasterxml.jackson.databind.ObjectMapper mapper = new com.fasterxml.jackson.databind.ObjectMapper();
                                        @SuppressWarnings("unchecked")
                                        Map<String, Object> json = mapper.readValue(data, Map.class);
                                        
                                        @SuppressWarnings("unchecked")
                                        List<Map<String, Object>> choices = (List<Map<String, Object>>) json.get("choices");
                                        
                                        if (choices != null && !choices.isEmpty()) {
                                            @SuppressWarnings("unchecked")
                                            Map<String, Object> firstChoice = choices.get(0);
                                            @SuppressWarnings("unchecked")
                                            Map<String, Object> delta = (Map<String, Object>) firstChoice.get("delta");
                                            
                                            if (delta != null) {
                                                String contentChunk = (String) delta.get("content");
                                                if (contentChunk != null && !contentChunk.isEmpty()) {
                                                    // è¿‡æ»¤æ‰ <think> æ ‡ç­¾åŠå…¶å†…å®¹
                                                    contentChunk = contentChunk.replaceAll("<think>.*?</think>", "");
                                                    contentChunk = contentChunk.replaceAll("<think>.*", ""); // å¤„ç†æœªé—­åˆçš„æƒ…å†µ
                                                    contentChunk = contentChunk.replaceAll(".*</think>", ""); // å¤„ç†è·¨chunkçš„ç»“æŸæ ‡ç­¾
                                                    
                                                    if (!contentChunk.isEmpty()) {
                                                        // å‘é€JSONæ ¼å¼æ•°æ®ï¼ŒåŒ…è£¹åœ¨contentå­—æ®µä¸­
                                                        Map<String, String> eventData = new HashMap<>();
                                                        eventData.put("content", contentChunk);
                                                        emitter.send(SseEmitter.event()
                                                            .name("message")
                                                            .data(eventData));
                                                        chunkCount++;
                                                        totalChars += contentChunk.length();
                                                        
                                                        if (chunkCount == 1) {
                                                            logger.info("âœ… å¼€å§‹æ¥æ”¶æµå¼æ•°æ®");
                                                        }
                                                        
                                                        // è°ƒè¯•ï¼šè®°å½•æ¢è¡Œç¬¦æ•°é‡
                                                        if (chunkCount % 50 == 0) {
                                                            int newlineCount = contentChunk.length() - contentChunk.replace("\n", "").length();
                                                            logger.info("ğŸ“Š Chunk #{}: é•¿åº¦={}, æ¢è¡Œç¬¦æ•°é‡={}", chunkCount, contentChunk.length(), newlineCount);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    } catch (Exception e) {
                                        logger.warn("âš ï¸ è§£ææµå¼å“åº”å¤±è´¥: {}", e.getMessage());
                                    }
                                }
                            }
                        }
                        
                        inputStream.close();
                        emitter.complete();
                        logger.info("âœ… AIå®¡ç¨¿å®Œæˆï¼Œæ€»chunkæ•°: {}, æ€»å­—ç¬¦æ•°: {}", chunkCount, totalChars);
                        
                    } catch (IOException e) {
                        logger.error("âŒ è¯»å–æµå¼å“åº”å¤±è´¥", e);
                        try {
                            emitter.completeWithError(e);
                        } catch (Exception ignored) {}
                    }
                    return null;
                });

        } catch (Exception e) {
            logger.error("âŒ AIå®¡ç¨¿å¤±è´¥", e);
            try {
                emitter.send(SseEmitter.event()
                    .name("error")
                    .data("å®¡ç¨¿å¤±è´¥: " + e.getMessage()));
                emitter.completeWithError(e);
            } catch (IOException ex) {
                logger.error("å‘é€é”™è¯¯äº‹ä»¶å¤±è´¥", ex);
            }
        }
    }
}
