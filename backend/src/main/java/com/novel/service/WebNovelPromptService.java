package com.novel.service;

import com.novel.domain.entity.Novel;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.Map;
import java.util.List;

/**
 * ç½‘æ–‡ä¸“ç”¨æç¤ºè¯æœåŠ¡
 * ä¸“é—¨ä¸ºç½‘ç»œå°è¯´åˆ›ä½œä¼˜åŒ–çš„AIæç¤ºè¯ç®¡ç†
 */
@Service
public class WebNovelPromptService {
    
    @Autowired
    private CharacterManagementService characterManagementService;

    /**
     * è·å–ç½‘æ–‡é£æ ¼çš„å†™ä½œæç¤ºè¯
     * 
     * @param novel å°è¯´ä¿¡æ¯
     * @param chapterPlan ç« èŠ‚è®¡åˆ’
     * @param wordCount ç›®æ ‡å­—æ•°
     * @return ç½‘æ–‡é£æ ¼æç¤ºè¯
     */
    public String getWebNovelWritingPrompt(Novel novel, Map<String, Object> chapterPlan, Integer wordCount) {
        String genrePrompt = getGenreSpecificPrompt(novel.getGenre());
        String coolPointsPrompt = getCoolPointsPrompt(novel.getGenre());
        String pacePrompt = getPaceControlPrompt();
        
        return String.format(
            "ä½ æ˜¯ã€ç½‘æ–‡åˆ›ä½œAIã€‘ï¼Œä¸“é—¨å†™ä½œç¬¦åˆèµ·ç‚¹ã€æ™‹æ±Ÿã€é£å¢ç­‰å¹³å°é£æ ¼çš„ç½‘ç»œå°è¯´ã€‚\\n\\n" +
            
            "## ğŸ“š ç½‘æ–‡æ ¸å¿ƒç†å¿µ\\n" +
            "- **çˆ½æ„Ÿç¬¬ä¸€**: æ¯ç« éƒ½è¦æœ‰è®©è¯»è€…çˆ½çš„ç‚¹\\n" +
            "- **èŠ‚å¥ç´§å‡‘**: å¿«èŠ‚å¥ï¼Œé¿å…æ‹–æ²“\\n" +
            "- **é’©å­ç»“å°¾**: ç« æœ«å¿…é¡»æœ‰æ‚¬å¿µï¼Œè®©è¯»è€…æƒ³çœ‹ä¸‹ä¸€ç« \\n" +
            "- **è¯»è€…å¯¼å‘**: æ—¶åˆ»è€ƒè™‘è¯»è€…çš„é˜…è¯»ä½“éªŒ\\n\\n" +
            
            "## ğŸ¯ å½“å‰ä»»åŠ¡\\n" +
            "- **å°è¯´**: ã€Š%sã€‹(%sç±»)\\n" +
            "- **ç« èŠ‚**: ç¬¬%dç« ã€Š%sã€‹\\n" +
            "- **ç±»å‹**: %s\\n" +
            "- **ç›®æ ‡å­—æ•°**: %då­—(ç½‘æ–‡æ ‡å‡†é•¿åº¦)\\n" +
            "- **æ ¸å¿ƒäº‹ä»¶**: %s\\n\\n" +
            
            "%s\\n\\n" +  // ç±»å‹ç‰¹è‰²æç¤ºè¯
            
            "## âš¡ ç½‘æ–‡å†™ä½œè¦æ±‚\\n" +
            "### 1. èŠ‚å¥æ§åˆ¶\\n" +
            "- å¼€å¤´è¦æœ‰å¸å¼•åŠ›ï¼Œç›´æ¥åˆ‡å…¥å†²çªæˆ–çˆ½ç‚¹\\n" +
            "- ä¸­é—´è¦æœ‰èµ·ä¼ï¼Œä¸èƒ½å¹³é“ºç›´å™\\n" +
            "- ç»“å°¾è¦æœ‰é’©å­ï¼Œåˆ¶é€ æ‚¬å¿µæˆ–æœŸå¾…\\n\\n" +
            
            "### 2. å¯¹è¯æŠ€å·§\\n" +
            "- å¤šç”¨å¯¹è¯æ¨è¿›æƒ…èŠ‚ï¼Œå‡å°‘å¤§æ®µç‹¬ç™½\\n" +
            "- å¯¹è¯è¦ç¬¦åˆè§’è‰²èº«ä»½å’Œæ€§æ ¼\\n" +
            "- é€‚å½“åŠ å…¥å†…å¿ƒOSï¼Œä½†ä¸è¦è¿‡å¤š\\n\\n" +
            
            "### 3. æå†™é£æ ¼\\n" +
            "- ç®€æ´ç›´æ¥ï¼Œé¿å…è¿‡äºæ–‡è‰ºçš„ä¿®è¾\\n" +
            "- é‡ç‚¹çªå‡ºï¼Œä¸è¦é¢é¢ä¿±åˆ°\\n" +
            "- é€‚å½“çš„ç»†èŠ‚æå†™å¢å¼ºä»£å…¥æ„Ÿ\\n\\n" +
            
            "%s\\n\\n" +  // çˆ½ç‚¹è®¾è®¡
            
            "%s\\n\\n" +  // èŠ‚å¥æ§åˆ¶
            
            "## ğŸ“ è¾“å‡ºæ ¼å¼\\n" +
            "```\\n" +
            "### ç¬¬%dç« ï¼š%s\\n\\n" +
            "[æ­£æ–‡å†…å®¹ - %då­—å·¦å³]\\n\\n" +
            "---\\n" +
            "ã€æœ¬ç« è¦ç‚¹ã€‘\\n" +
            "- çˆ½ç‚¹ï¼š[æœ¬ç« çš„çˆ½ç‚¹æ˜¯ä»€ä¹ˆ]\\n" +
            "- æ¨è¿›ï¼š[å‰§æƒ…å¦‚ä½•æ¨è¿›]\\n" +
            "- é’©å­ï¼š[ç« æœ«æ‚¬å¿µè®¾ç½®]\\n" +
            "```\\n\\n" +
            
            "**é‡è¦**: ä¸€å®šè¦å†™å‡ºè®©è¯»è€…æƒ³ç»§ç»­çœ‹ä¸‹å»çš„å†…å®¹ï¼",
            
            novel.getTitle(), novel.getGenre(),
            (Integer) chapterPlan.get("chapterNumber"), chapterPlan.get("title"),
            chapterPlan.get("type"), wordCount, chapterPlan.get("coreEvent"),
            genrePrompt, coolPointsPrompt, pacePrompt,
            (Integer) chapterPlan.get("chapterNumber"), chapterPlan.get("title"), wordCount
        );
    }

    /**
     * è·å–ç½‘æ–‡é£æ ¼çš„å¤§çº²ç”Ÿæˆæç¤ºè¯
     */
    public String getWebNovelOutlinePrompt(Novel novel, String basicIdea) {
        return String.format(
            "ä½ æ˜¯ã€ç½‘æ–‡å¤§çº²ç­–åˆ’å¸ˆã€‘ï¼Œä¸“é—¨ä¸ºç½‘ç»œå°è¯´è®¾è®¡å¤§çº²ã€‚\\n\\n" +
            
            "## ğŸ“– å°è¯´ä¿¡æ¯\\n" +
            "- æ ‡é¢˜ï¼š%s\\n" +
            "- ç±»å‹ï¼š%s\\n" +
            "- åŸºæœ¬æ„æ€ï¼š%s\\n\\n" +
            
            "## ğŸ¯ ç½‘æ–‡å¤§çº²è®¾è®¡åŸåˆ™\\n" +
            "1. **é»„é‡‘ä¸‰ç« æ³•åˆ™**: å‰3ç« è¦æŠ“ä½è¯»è€…\\n" +
            "2. **çˆ½ç‚¹å¸ƒå±€**: æ¯10ç« å·¦å³è¦æœ‰ä¸€ä¸ªå¤§çˆ½ç‚¹\\n" +
            "3. **èŠ‚å¥æŠŠæ§**: å¿«æ…¢ç»“åˆï¼Œå¼ å¼›æœ‰åº¦\\n" +
            "4. **æ‚¬å¿µç®¡ç†**: è§£å†³ä¸€ä¸ªæ‚¬å¿µï¼ŒåŸ‹ä¸‹æ–°çš„æ‚¬å¿µ\\n" +
            "5. **è§’è‰²æˆé•¿**: ä¸»è§’è¦æœ‰æ˜æ˜¾çš„æˆé•¿è½¨è¿¹\\n\\n" +
            
            "%s\\n\\n" +  // ç±»å‹ç‰¹è‰²
            
            "## ğŸ“‹ å¤§çº²ç»“æ„è¦æ±‚\\n" +
            "```json\\n" +
            "{\\n" +
            "  \\\"overallStructure\\\": {\\n" +
            "    \\\"totalVolumes\\\": 3,\\n" +
            "    \\\"estimatedChapters\\\": 300,\\n" +
            "    \\\"targetWords\\\": 600000\\n" +
            "  },\\n" +
            "  \\\"volumePlanning\\\": [\\n" +
            "    {\\n" +
            "      \\\"volumeNumber\\\": 1,\\n" +
            "      \\\"title\\\": \\\"å·å\\\",\\n" +
            "      \\\"theme\\\": \\\"æ ¸å¿ƒä¸»é¢˜\\\",\\n" +
            "      \\\"chapters\\\": \\\"1-100\\\",\\n" +
            "      \\\"mainConflict\\\": \\\"ä¸»è¦å†²çª\\\",\\n" +
            "      \\\"coolPoints\\\": [\\\"çˆ½ç‚¹1\\\", \\\"çˆ½ç‚¹2\\\"],\\n" +
            "      \\\"climax\\\": \\\"é«˜æ½®è®¾ç½®\\\"\\n" +
            "    }\\n" +
            "  ],\\n" +
            "  \\\"characterSystem\\\": {\\n" +
            "    \\\"protagonist\\\": \\\"ä¸»è§’è®¾å®š\\\",\\n" +
            "    \\\"powerSystem\\\": \\\"åŠ›é‡ä½“ç³»\\\",\\n" +
            "    \\\"relationships\\\": \\\"é‡è¦å…³ç³»\\\"\\n" +
            "  },\\n" +
            "  \\\"hookPoints\\\": [\\n" +
            "    {\\\"chapter\\\": 1, \\\"hook\\\": \\\"å¼€ç¯‡é’©å­\\\"},\\n" +
            "    {\\\"chapter\\\": 10, \\\"hook\\\": \\\"ç¬¬ä¸€ä¸ªå¤§é’©å­\\\"}\\n" +
            "  ]\\n" +
            "}\\n" +
            "```\\n\\n" +
            
            "ç¡®ä¿å¤§çº²ç¬¦åˆ%sç±»ç½‘æ–‡çš„ç‰¹ç‚¹ï¼Œæœ‰è¶³å¤Ÿçš„çˆ½ç‚¹å’Œæ‚¬å¿µï¼",
            
            novel.getTitle(), novel.getGenre(), basicIdea,
            getGenreOutlinePrompt(novel.getGenre()), novel.getGenre()
        );
    }

    /**
     * è·å–ç½‘æ–‡é£æ ¼çš„å»ºè®®ç”Ÿæˆæç¤ºè¯
     */
    public String getWebNovelSuggestionsPrompt(Novel novel, Map<String, Object> memoryBank, Integer currentChapter) {
        return String.format(
            "ä½ æ˜¯ã€ç½‘æ–‡åˆ›ä½œé¡¾é—®ã€‘ï¼Œä¸“é—¨ä¸ºç½‘ç»œå°è¯´ä½œè€…æä¾›åˆ›ä½œå»ºè®®ã€‚\\n\\n" +
            
            "## ğŸ“Š å½“å‰çŠ¶æ€\\n" +
            "- å°è¯´ï¼šã€Š%sã€‹(%sç±»)\\n" +
            "- å½“å‰ç« èŠ‚ï¼šç¬¬%dç« \\n" +
            "- åˆ›ä½œçŠ¶æ€ï¼šæ­£åœ¨è¿è½½\\n\\n" +
            
            "## ğŸ¯ ç½‘æ–‡å»ºè®®é‡ç‚¹\\n" +
            "### 1. çˆ½ç‚¹åˆ†æ ğŸ”¥\\n" +
            "- æœ€è¿‘10ç« çš„çˆ½ç‚¹å¯†åº¦å¦‚ä½•ï¼Ÿ\\n" +
            "- ä¸‹ä¸€ä¸ªçˆ½ç‚¹åº”è¯¥è®¾ç½®åœ¨å“ªé‡Œï¼Ÿ\\n" +
            "- ä»€ä¹ˆç±»å‹çš„çˆ½ç‚¹æœ€é€‚åˆå½“å‰å‰§æƒ…ï¼Ÿ\\n\\n" +
            
            "### 2. èŠ‚å¥è¯Šæ–­ âš¡\\n" +
            "- å½“å‰èŠ‚å¥æ˜¯å¦åˆé€‚ï¼Ÿå¤ªå¿«æˆ–å¤ªæ…¢ï¼Ÿ\\n" +
            "- æ˜¯å¦éœ€è¦è°ƒæ•´å†™ä½œèŠ‚å¥ï¼Ÿ\\n" +
            "- è¯»è€…å¯èƒ½çš„ç–²åŠ³ç‚¹åœ¨å“ªé‡Œï¼Ÿ\\n\\n" +
            
            "### 3. æ‚¬å¿µç®¡ç† ğŸ”—\\n" +
            "- å½“å‰æœ‰å“ªäº›æœªè§£å†³çš„æ‚¬å¿µï¼Ÿ\\n" +
            "- å“ªäº›æ‚¬å¿µè¯¥è§£å†³äº†ï¼Ÿ\\n" +
            "- éœ€è¦åŸ‹è®¾æ–°çš„æ‚¬å¿µå—ï¼Ÿ\\n\\n" +
            
            "### 4. è§’è‰²å‘å±• ğŸ‘¥\\n" +
            "- ä¸»è§’çš„æˆé•¿è½¨è¿¹æ˜¯å¦æ¸…æ™°ï¼Ÿ\\n" +
            "- é…è§’æ˜¯å¦éœ€è¦æ›´å¤šæˆä»½ï¼Ÿ\\n" +
            "- è§’è‰²å…³ç³»æ˜¯å¦éœ€è¦æ–°çš„å‘å±•ï¼Ÿ\\n\\n" +
            
            "### 5. ç±»å‹ç‰¹è‰² ğŸ·ï¸\\n" +
            "%s\\n\\n" +
            
            "## ğŸ“ è¾“å‡ºæ ¼å¼\\n" +
            "```json\\n" +
            "{\\n" +
            "  \\\"urgentSuggestions\\\": [\\n" +
            "    {\\\"type\\\": \\\"çˆ½ç‚¹\\\", \\\"content\\\": \\\"å…·ä½“å»ºè®®\\\", \\\"priority\\\": \\\"high\\\"}\\n" +
            "  ],\\n" +
            "  \\\"rhythmAnalysis\\\": {\\n" +
            "    \\\"currentPace\\\": \\\"é€‚ä¸­/åå¿«/åæ…¢\\\",\\n" +
            "    \\\"suggestion\\\": \\\"å…·ä½“å»ºè®®\\\"\\n" +
            "  },\\n" +
            "  \\\"nextChapterFocus\\\": \\\"ä¸‹ä¸€ç« é‡ç‚¹å…³æ³¨ä»€ä¹ˆ\\\",\\n" +
            "  \\\"readerRetention\\\": \\\"å¦‚ä½•æé«˜è¯»è€…ç•™å­˜\\\",\\n" +
            "  \\\"warningPoints\\\": [\\\"éœ€è¦æ³¨æ„çš„é—®é¢˜\\\"]\\n" +
            "}\\n" +
            "```\\n\\n" +
            
            "é‡ç‚¹å…³æ³¨è¯»è€…ä½“éªŒå’Œè¿½è¯»ç‡ï¼",
            
            novel.getTitle(), novel.getGenre(), currentChapter,
            getGenreAdvicePrompt(novel.getGenre())
        );
    }

    // ================================
    // åˆ†ç±»å‹ç‰¹è‰²æç¤ºè¯
    // ================================

    /**
     * è·å–ç±»å‹ç‰¹è‰²æç¤ºè¯
     */
    private String getGenreSpecificPrompt(String genre) {
        Map<String, String> genrePrompts = new HashMap<>();
        
        genrePrompts.put("ç„å¹»", 
            "## ğŸ”® ç„å¹»ç½‘æ–‡ç‰¹è‰²\\n" +
            "- **ç­‰çº§ä½“ç³»**: å¢ƒç•Œè¦æ¸…æ™°ï¼Œå‡çº§è¦æœ‰ä»ªå¼æ„Ÿ\\n" +
            "- **è£…é€¼æ‰“è„¸**: é€‚åº¦è£…é€¼ï¼Œç‹ ç‹ æ‰“è„¸\\n" +
            "- **å®ç‰©åŠŸæ³•**: è®©è¯»è€…çœ¼å‰ä¸€äº®çš„å¥½ä¸œè¥¿\\n" +
            "- **ç¾å¥³é…è§’**: å€¾å›½å€¾åŸä½†ä¸èƒ½æŠ¢ä¸»è§’é£å¤´\\n" +
            "- **åæ´¾è®¾è®¡**: è¦è®©è¯»è€…æ¨å¾—ç‰™ç—’ç—’\\n" +
            "- **é¿å…**: è¿‡åº¦ä¿®ä»™å“²ç†ï¼Œæ¯ç‡¥çš„ç­‰çº§ä»‹ç»"
        );
        
        genrePrompts.put("éƒ½å¸‚", 
            "## ğŸ¢ éƒ½å¸‚ç½‘æ–‡ç‰¹è‰²\\n" +
            "- **è£…é€¼è¦è‡ªç„¶**: ä¸åˆ»æ„ï¼Œé¡ºå…¶è‡ªç„¶åœ°å±•ç¤ºå®åŠ›\\n" +
            "- **é‡‘é’±åœ°ä½**: è±ªè½¦åè¡¨è¦æ°åˆ°å¥½å¤„\\n" +
            "- **ç¾å¥³è¦ç°ä»£**: ç¬¦åˆéƒ½å¸‚äººè®¾ï¼Œä¸è¦å¤ªå¤¸å¼ \\n" +
            "- **åæ´¾ç°å®æ„Ÿ**: ä¸èƒ½å¤ªè„¸è°±åŒ–\\n" +
            "- **ä¸“ä¸šé¢†åŸŸ**: åŒ»æœ¯/å•†æˆ˜/ç§‘æŠ€è¦æœ‰ä¸“ä¸šæ„Ÿ\\n" +
            "- **é¿å…**: è¿‡åº¦ç‚«å¯Œï¼Œè„±ç¦»ç°å®çš„å‰§æƒ…"
        );
        
        genrePrompts.put("ç³»ç»Ÿ", 
            "## ğŸ’» ç³»ç»Ÿæµç‰¹è‰²\\n" +
            "- **ç³»ç»Ÿå¥–åŠ±**: è¦è®©è¯»è€…çœ¼é¦‹çš„å¥½ä¸œè¥¿\\n" +
            "- **ä»»åŠ¡è®¾è®¡**: æœ‰æŒ‘æˆ˜ä½†èƒ½å®Œæˆ\\n" +
            "- **å‡çº§ä»ªå¼æ„Ÿ**: æ•°æ®å˜åŒ–è¦çˆ½\\n" +
            "- **ç³»ç»Ÿäº’åŠ¨**: æœ‰ä¸ªæ€§ï¼Œä¸æ­»æ¿\\n" +
            "- **å•†åŸç³»ç»Ÿ**: å¥½ä¸œè¥¿è¦å¤šï¼Œä½†ä¸èƒ½å¤ªå®¹æ˜“å¾—åˆ°\\n" +
            "- **é¿å…**: çº¯æ•°æ®å †ç Œï¼Œå¿½ç•¥å‰§æƒ…"
        );
        
        genrePrompts.put("é‡ç”Ÿ", 
            "## ğŸ”„ é‡ç”Ÿæ–‡ç‰¹è‰²\\n" +
            "- **å…ˆçŸ¥ä¼˜åŠ¿**: åˆç†åˆ©ç”¨é‡ç”Ÿä¼˜åŠ¿\\n" +
            "- **æ”¹å˜å‘½è¿**: è¦æœ‰å¼ºçƒˆçš„å¯¹æ¯”æ„Ÿ\\n" +
            "- **å¤ä»‡çˆ½æ„Ÿ**: æŠ¥ä»‡è¦æŠ¥å¾—è§£æ°”\\n" +
            "- **æƒ…æ„Ÿçº è‘›**: å‰ä¸–ä»Šç”Ÿçš„æƒ…æ„Ÿå¤„ç†\\n" +
            "- **è´è¶æ•ˆåº”**: æ”¹å˜è¦åˆç†\\n" +
            "- **é¿å…**: è¿‡åº¦ä¾èµ–å…ˆçŸ¥ï¼Œç¼ºå°‘æŒ‘æˆ˜"
        );

        return genrePrompts.getOrDefault(genre, getDefaultGenrePrompt());
    }

    /**
     * è·å–çˆ½ç‚¹è®¾è®¡æç¤ºè¯
     */
    private String getCoolPointsPrompt(String genre) {
        return "## ğŸ”¥ çˆ½ç‚¹è®¾è®¡æ¸…å•\\n" +
               "### å‡çº§çˆ½ç‚¹\\n" +
               "- å®åŠ›çªç ´ï¼Œè·å¾—æ–°èƒ½åŠ›\\n" +
               "- åœ°ä½æå‡ï¼Œè·å¾—è®¤å¯\\n" +
               "- è´¢å¯Œå¢é•¿ï¼Œç”Ÿæ´»æ”¹å–„\\n\\n" +
               
               "### æ‰“è„¸çˆ½ç‚¹\\n" +
               "- è¢«çœ‹ä¸èµ·åçš„å¼ºåŠ¿åå‡»\\n" +
               "- éšè—å®åŠ›çš„éœ‡æ’¼å±•ç°\\n" +
               "- é¢„è¨€æˆçœŸï¼Œæ‰“è„¸è´¨ç–‘è€…\\n\\n" +
               
               "### æƒ…æ„Ÿçˆ½ç‚¹\\n" +
               "- ç¾å¥³çš„é’çå’Œç¤ºå¥½\\n" +
               "- æœ‹å‹çš„çœŸå¿ƒè®¤å¯\\n" +
               "- å®¶äººçš„éª„å‚²å’Œæ”¯æŒ\\n\\n" +
               
               "**æœ¬ç« å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ˜ç¡®çš„çˆ½ç‚¹ï¼**";
    }

    /**
     * è·å–èŠ‚å¥æ§åˆ¶æç¤ºè¯
     */
    private String getPaceControlPrompt() {
        return "## âš¡ èŠ‚å¥æ§åˆ¶æŠ€å·§\\n" +
               "### å¼€å¤´(å‰20%)\\n" +
               "- å¿«é€Ÿè¿›å…¥çŠ¶å†µï¼ŒæŠ“ä½è¯»è€…\\n" +
               "- ç›´æ¥å±•ç¤ºå†²çªæˆ–æ‚¬å¿µ\\n" +
               "- é¿å…è¿‡å¤šèƒŒæ™¯é“ºå«\\n\\n" +
               
               "### ä¸­æ®µ(ä¸­60%)\\n" +
               "- æ¨è¿›ä¸»çº¿ï¼Œå‘å±•æ”¯çº¿\\n" +
               "- é€‚å½“çš„è½¬æŠ˜å’Œå˜åŒ–\\n" +
               "- ä¿æŒè¯»è€…çš„æœŸå¾…æ„Ÿ\\n\\n" +
               
               "### ç»“å°¾(å20%)\\n" +
               "- è§£å†³æœ¬ç« å†²çª\\n" +
               "- åŸ‹è®¾ä¸‹ç« æ‚¬å¿µ\\n" +
               "- ç»™è¯»è€…ç»§ç»­é˜…è¯»çš„åŠ¨åŠ›\\n\\n" +
               
               "**ç« æœ«é’©å­æ˜¯å…³é”®ï¼Œä¸€å®šè¦è®©è¯»è€…æƒ³çœ‹ä¸‹ä¸€ç« ï¼**";
    }

    /**
     * è·å–ç±»å‹å¤§çº²æç¤ºè¯
     */
    private String getGenreOutlinePrompt(String genre) {
        Map<String, String> outlinePrompts = new HashMap<>();
        
        outlinePrompts.put("ç„å¹»", 
            "### ç„å¹»å¤§çº²è¦ç‚¹\\n" +
            "- ä¿®ç‚¼ä½“ç³»è¦å®Œæ•´ï¼šç»ƒæ°”â†’ç­‘åŸºâ†’é‡‘ä¸¹â†’å…ƒå©´...\\n" +
            "- é—¨æ´¾åŠ¿åŠ›è¦åˆ†æ˜ï¼šæ­£æ´¾ã€é­”é“ã€æ•£ä¿®\\n" +
            "- å®ç‰©ç­‰çº§è¦æ¸…æ™°ï¼šå‡¡å™¨â†’å®å™¨â†’çµå™¨â†’ä»™å™¨\\n" +
            "- åœ°å›¾è¦åˆ†å±‚ï¼šå°æ‘â†’åŸæ± â†’ç‹æœâ†’å¤§é™†â†’æ˜ŸåŸŸ"
        );
        
        outlinePrompts.put("éƒ½å¸‚",
            "### éƒ½å¸‚å¤§çº²è¦ç‚¹\\n" +
            "- èº«ä»½è¦æœ‰å±‚æ¬¡ï¼šæ™®é€šäººâ†’å°æœ‰æˆå°±â†’è¡Œä¸šç¿˜æ¥šâ†’é¡¶çº§å¤§ä½¬\\n" +
            "- åŠ¿åŠ›è¦ç°å®ï¼šå®¶æ—ã€å…¬å¸ã€å®˜åœºã€é»‘ç™½ä¸¤é“\\n" +
            "- èƒ½åŠ›è¦åˆç†ï¼šåŒ»æœ¯ã€å•†æˆ˜ã€åŠŸå¤«ã€å¼‚èƒ½\\n" +
            "- åœºæ™¯è¦ä¸°å¯Œï¼šå­¦æ ¡ã€èŒåœºã€å•†åœºã€ä¸Šæµç¤¾ä¼š"
        );

        return outlinePrompts.getOrDefault(genre, "### é€šç”¨å¤§çº²è¦ç‚¹\\n- è§’è‰²æˆé•¿æ¸…æ™°\\n- å†²çªå±‚å±‚é€’è¿›\\n- æ‚¬å¿µç¯ç¯ç›¸æ‰£");
    }

    /**
     * è·å–ç±»å‹å»ºè®®æç¤ºè¯
     */
    private String getGenreAdvicePrompt(String genre) {
        Map<String, String> advicePrompts = new HashMap<>();
        
        advicePrompts.put("ç„å¹»",
            "### ç„å¹»åˆ›ä½œè¦ç‚¹\\n" +
            "- å¢ƒç•Œæå‡çš„é¢‘ç‡æ˜¯å¦åˆé€‚ï¼Ÿ\\n" +
            "- æ‰“è„¸æƒ…èŠ‚æ˜¯å¦å¤Ÿçˆ½ï¼Ÿ\\n" +
            "- å®ç‰©åŠŸæ³•æ˜¯å¦å¸å¼•äººï¼Ÿ\\n" +
            "- æ•Œäººæ˜¯å¦è¶³å¤Ÿå¼ºå¤§ï¼Ÿ"
        );
        
        advicePrompts.put("éƒ½å¸‚",
            "### éƒ½å¸‚åˆ›ä½œè¦ç‚¹\\n" +
            "- è£…é€¼æ˜¯å¦è‡ªç„¶ä¸åšä½œï¼Ÿ\\n" +
            "- ä¸“ä¸šçŸ¥è¯†æ˜¯å¦åˆ°ä½ï¼Ÿ\\n" +
            "- æƒ…æ„Ÿæˆæ˜¯å¦æ°å½“ï¼Ÿ\\n" +
            "- åæ´¾æ˜¯å¦æœ‰ç°å®æ„Ÿï¼Ÿ"
        );

        return advicePrompts.getOrDefault(genre, "### é€šç”¨åˆ›ä½œè¦ç‚¹\\n- èŠ‚å¥æ˜¯å¦åˆé€‚ï¼Ÿ\\n- è§’è‰²æ˜¯å¦ç«‹ä½“ï¼Ÿ\\n- å†²çªæ˜¯å¦æ¿€çƒˆï¼Ÿ");
    }

    /**
     * è·å–é»˜è®¤ç±»å‹æç¤ºè¯
     */
    private String getDefaultGenrePrompt() {
        return "## ğŸ“ é€šç”¨ç½‘æ–‡ç‰¹è‰²\\n" +
               "- **å¿«èŠ‚å¥**: é¿å…æ‹–æ²“ï¼Œæ¯ç« éƒ½è¦æœ‰æ¨è¿›\\n" +
               "- **å¼ºä»£å…¥**: è®©è¯»è€…æœ‰ä»£å…¥æ„Ÿ\\n" +
               "- **çˆ½ç‚¹**: é€‚å½“çš„çˆ½ç‚¹å’Œæˆå°±æ„Ÿ\\n" +
               "- **æ‚¬å¿µ**: ä¿æŒè¯»è€…çš„å¥½å¥‡å¿ƒ\\n" +
               "- **é¿å…**: è¿‡äºæ–‡è‰ºï¼Œè„±ç¦»è¯»è€…æœŸå¾…";
    }

    /**
     * æ„å»ºé«˜è´¨é‡é•¿ç¯‡å°è¯´åˆ›ä½œæç¤ºè¯
     * åŸºäºä¸“ä¸šè¯„ä»·å®Œå…¨é‡æ„ï¼Œè§£å†³AIæµæ°´çº¿é—®é¢˜  
     * æ ¸å¿ƒç†å¿µï¼šå…‹åˆ¶ã€å»¶è¿Ÿã€æ¨¡ç³Šã€ä»£ä»·
     */
    public String buildEnhancedStreamingPrompt(
            Novel novel,
            Map<String, Object> chapterPlan,
            Map<String, Object> memoryBank,
            String userAdjustment) {
        
        Integer chapterNumber = (Integer) chapterPlan.get("chapterNumber");
        String chapterTitle = (String) chapterPlan.get("title");
        Integer estimatedWords = (Integer) chapterPlan.get("estimatedWords");
        
        StringBuilder prompt = new StringBuilder();
        
        // åŠ¨æ€çš„åˆ›ä½œè€…èº«ä»½ - åŸºäºå°è¯´ç±»å‹å’Œè®¾å®š
        String creatorIdentity = buildDynamicCreatorIdentity(novel.getGenre());
        prompt.append(creatorIdentity).append("\\n\\n")
              
              .append("**ã€ç½‘æ–‡é•¿ç¯‡åˆ›ä½œæ ¸å¿ƒç†å¿µã€‘**\\n")
              .append("â€¢ **å…‹åˆ¶åŸåˆ™**ï¼šä¸è§£é‡Šï¼Œåªå‘ˆç°ï¼›ä¸å®šä¹‰ï¼Œåªæš—ç¤º\\n")
              .append("â€¢ **å»¶è¿ŸåŸåˆ™**ï¼šä¿¡æ¯é€æ­¥é€éœ²ï¼Œç¥ç§˜æ„Ÿå±‚å±‚æ·±å…¥\\n")
              .append("â€¢ **æ¨¡ç³ŠåŸåˆ™**ï¼šå¼‚å¸¸é€šè¿‡æ„Ÿè§‰æš—ç¤ºï¼Œé¿å…ç›´æ¥æè¿°\\n")
              .append("â€¢ **ä»£ä»·åŸåˆ™**ï¼šåŠ›é‡è·å–å¿…é¡»æœ‰ç—›è‹¦ã€é£é™©ã€å¤±æ§\\n")
              .append("â€¢ **è§†è§’ç»Ÿä¸€**ï¼šæ˜ç¡®èšç„¦ä¸»è§’ï¼Œé¿å…è§†è§’æ··ä¹±\\n\\n")
              
              .append(buildAntiAIDetectionRules(novel, chapterNumber)).append("\\n\\n")
              
              .append("**ã€æ·±åº¦ä¼˜åŒ–Â·å¯ç”Ÿé•¿å¼€å¤´æ³•åˆ™ã€‘**\\n")
              .append("### 1. è§†è§’èšç„¦æŠ€å·§\\n")
              .append("- æ˜ç¡®ä¸»è§’è§†è§’ï¼Œé¿å…å¤šè§’è‰²è§†è§’æ··åˆ\\n")
              .append("- é…è§’ä½œä¸ºèƒŒæ™¯å­˜åœ¨ï¼Œé€šè¿‡ä¸»è§’è§†è§’è§‚å¯Ÿ\\n")
              .append("- é¿å…é•œå¤´ä¹±åˆ‡ï¼Œç¡®ä¿å™äº‹ç„¦ç‚¹æ˜ç¡®\\n\\n")
              
              .append("### 2. æ¢¦å¢ƒæ”¹é€ æŠ€å·§\\n")
              .append("- æ”¹ä¸ºï¼šæ¢¦ä¸­åªå‡ºç°ç¬¦å·ã€ä½è¯­ã€æ®‹åƒï¼Œæ— æ³•ç†è§£\\n")
              .append("- ä¸è¦ç™½å‘è€è€…ç›´æ¥å®£å¸ƒè®¾å®š\\n")
              .append("- ä¿¡æ¯ç¢ç‰‡åŒ–ï¼Œç”šè‡³å¯èƒ½è¯¯å¯¼ä¸»è§’\\n")
              .append("- ä¼´éšç—›è‹¦ï¼šå¤±å¿†ã€å¹»è§‰ã€è¢«é™„èº«æ„Ÿ\\n\\n")
              
              .append("### 3. è§‰é†’çœŸå®åŒ–æŠ€å·§\\n")
              .append("- é€æ¸å¼‚å¸¸ï¼šè€³é¸£ã€å¹»è§†ã€æ€•å…‰ï¼Œè¢«å®¶äººæ€€ç–‘\\n")
              .append("- åŠ›é‡ä¸ç¨³å®šï¼šæ—¶æœ‰æ—¶æ— ã€éš¾ä»¥æ§åˆ¶\\n")
              .append("- ç¤¾ä¼šéš”ç¦»ï¼šé‚»å±…ç–è¿œã€è¢«å½“ä½œç—…äºº\\n")
              .append("- è‡ªæˆ‘æ€€ç–‘ï¼šæ€€ç–‘è‡ªå·±ç–¯äº†ï¼Œææƒ§è¢«å‘ç°\\n\\n")
              
              .append("### 4. è¶…è‡ªç„¶æ¨¡ç³ŠåŒ–\\n")
              .append("- åªè§‰ä½©åˆ€\"ä¸å¯¹åŠ²\"ï¼Œåƒæœ‰ä¸œè¥¿åœ¨åŠ¨ï¼Œä½†çœ‹ä¸æ¸…\\n")
              .append("- é•œé¢æµ®ç°æ— æ³•è¾¨è®¤çš„å¤å­—ï¼Œä¸»è§’è¯¯è¯»è¯¯è§£\\n")
              .append("- ç”¨ç¯å¢ƒç»†èŠ‚æš—ç¤ºï¼šåŠ¨ç‰©é€ƒèµ°ã€é£å‘å¼‚å¸¸\\n")
              .append("- è®©ä¸»è§’ï¼ˆå’Œè¯»è€…ï¼‰çŒœæµ‹è€Œéç›´æ¥å‘ŠçŸ¥\\n\\n")
              
              .append(buildAdvancedAntiAITechniques(novel, chapterNumber)).append("\\n\\n")
              
              .append("**ã€").append(novel.getGenre()).append("ç±»æ·±åº¦é‡æ„ã€‘**\\n");
              
        // æ·»åŠ ä¼˜åŒ–åçš„ç±»å‹ç‰¹å®šæŒ‡å¯¼
        String genreSpecific = getAdvancedGenreGuidance(novel.getGenre(), chapterNumber);
        prompt.append(genreSpecific).append("\\n");
        
        // å½“å‰ä»»åŠ¡ä¿¡æ¯ - ç®€åŒ–ä½†æ›´èšç„¦
        prompt.append("ğŸ“– **æœ¬ç« åˆ›ä½œç›®æ ‡**\\n")
              .append("- ä½œå“ï¼šã€Š").append(novel.getTitle()).append("ã€‹ç¬¬").append(chapterNumber).append("ç« ");
        if (chapterTitle != null && !chapterTitle.isEmpty()) {
            prompt.append("ã€Š").append(chapterTitle).append("ã€‹");
        }
        prompt.append("\\n")
              .append("- å­—æ•°ï¼š").append(estimatedWords).append("å­—ï¼ˆä¸¥æ ¼æ§åˆ¶ï¼‰\\n")
              .append("- æ ¸å¿ƒäº‹ä»¶ï¼š").append(chapterPlan.get("coreEvent")).append("\\n\\n");
        
        // åŠ¨æ€æ ¸å¿ƒä¸Šä¸‹æ–‡ï¼ˆä»è®°å¿†åº“æ™ºèƒ½æå–ï¼‰
        if (memoryBank != null) {
            String dynamicContext = buildDynamicContextFromMemory(novel, memoryBank, chapterNumber);
            if (!dynamicContext.isEmpty()) {
                prompt.append("ğŸ§  **åˆ›ä½œè®°å¿†è¦ç‚¹**\\n").append(dynamicContext).append("\\n");
            }
        }
        
        // ç”¨æˆ·ç‰¹æ®Šè¦æ±‚
        if (userAdjustment != null && !userAdjustment.trim().isEmpty()) {
            prompt.append("âœ¨ **åˆ›ä½œè€…è¦æ±‚**ï¼š").append(userAdjustment).append("\\n\\n");
        }
        
        // ç« èŠ‚ç‰¹å®šæŒ‡å¯¼
        if (chapterNumber <= 10) {
            prompt.append("**ã€å¼€ç¯‡ç« èŠ‚æ ¸å¿ƒåŸåˆ™ã€‘**\\n")
                  .append("â€¢ æ…¢å¯åŠ¨å»ºç«‹ï¼šæ—¥å¸¸æ„Ÿ + ä¸€ä¸ªä»¤äººç–‘æƒ‘çš„ç»†èŠ‚\\n")
                  .append("â€¢ æ‚¬å¿µè¥é€ ï¼š3ä¸ªç–‘é—® + 1ä¸ªæƒ…æ„Ÿ + 0ä¸ªè§£ç­”\\n")
                  .append("â€¢ æƒ…æ„ŸæŠ•å…¥ï¼šè®©è¯»è€…å…ˆå…³å¿ƒè§’è‰²ï¼Œå†å¼•å…¥ç¥ç§˜\\n")
                  .append("â€¢ ç¦æ­¢ç›´æ¥ï¼šè§‰é†’ã€ä¼ æ‰¿ã€ç³»ç»Ÿã€åæ´¾ç™»åœº\\n\\n");
        }
        
        // æœ€ç»ˆæ‰§è¡Œæ ‡å‡†
        prompt.append("**ã€è¾“å‡ºæ ‡å‡†ã€‘**\\n")
              .append("â€¢ **é¦–è¡Œæ ¼å¼**ï¼šä¸¥æ ¼ä»¥ #çˆ†æ¬¾æ ‡é¢˜# å¼€å¤´ï¼ˆå¿…é¡»ä½¿ç”¨#å·åŒ…è£¹ï¼Œä¸è¦ä½¿ç”¨ä¹¦åå·ï¼‰\\n")
              .append("  ç¤ºä¾‹æ ¼å¼ï¼š#è¡€å¤œæƒŠé­‚ï¼Œå¤åˆ€å¼‚åŠ¨# æˆ– #æš—æ½®æ¶ŒåŠ¨ï¼ŒçœŸç›¸æµ®ç°#\\n")
              .append("  - æ ‡é¢˜è¦æœ‰æ‚¬å¿µæ„Ÿå’Œå¸å¼•åŠ›\\n")
              .append("  - æ ‡é¢˜å­—æ•°æ§åˆ¶åœ¨6-12å­—\\n")
              .append("  - æ ‡é¢˜ä¸è¦åŒ…å«\"ç¬¬Xç« \"å­—æ ·\\n")
              .append("â€¢ ç¬¬äºŒè¡Œï¼šç©ºè¡Œ\\n")
              .append("â€¢ ç¬¬ä¸‰è¡Œå¼€å§‹ï¼šæ­£æ–‡å†…å®¹ï¼ˆæ— å…¶ä»–è¯´æ˜ã€æ³¨é‡Šï¼‰\\n")
              .append("â€¢ å­—æ•°æ§åˆ¶ï¼š").append(estimatedWords).append("å­—å·¦å³\\n")
              .append("â€¢ ç« æœ«é’©å­ï¼šå¿…é¡»ç•™ä¸‹è®©è¯»è€…æƒ³ç»§ç»­çœ‹çš„æ‚¬å¿µ\\n")
              .append("â€¢ äººç±»è´¨æ„Ÿï¼šé¿å…AIæµæ°´çº¿äº§å“çš„ç—•è¿¹\\n\\n")
              
              .append("ğŸš€ **ç°åœ¨å¼€å§‹åˆ›ä½œï¼ˆä¸¥æ ¼æŒ‰ç…§æ ¼å¼ï¼Œé¦–è¡Œå¿…é¡»æ˜¯#æ ‡é¢˜#ï¼‰ï¼š**");
        
        return prompt.toString();
    }
    
    /**
     * å‹ç¼©è§’è‰²ä¿¡æ¯ä¸ºæç¤ºè¯æ ¸å¿ƒè¦ç‚¹
     */
    private String compressCharacterInfoForPrompt(String fullCharacterInfo) {
        if (fullCharacterInfo == null || fullCharacterInfo.trim().isEmpty()) {
            return "";
        }
        
        // ç®€åŒ–è§’è‰²ä¿¡æ¯ï¼Œåªä¿ç•™çŠ¶æ€å…³é”®è¯
        String[] lines = fullCharacterInfo.split("\\n");
        StringBuilder compressed = new StringBuilder();
        compressed.append("æè‰¯ï¼ˆ16å²ä¸»è§’ï¼‰ç°çŠ¶ï¼š");
        
        for (String line : lines) {
            if (line.contains("æè‰¯") && line.contains("çŠ¶æ€")) {
                // æå–å…³é”®çŠ¶æ€ä¿¡æ¯
                String statusInfo = line.replaceAll(".*çŠ¶æ€[ï¼š:]", "").trim();
                if (!statusInfo.isEmpty()) {
                    compressed.append(statusInfo).append("ï¼›");
                    break;
                }
            }
        }
        
        return compressed.toString();
    }
    
    /**
     * ä»è®°å¿†åº“åŠ¨æ€æ„å»ºæ ¸å¿ƒä¸Šä¸‹æ–‡ä¿¡æ¯
     */
    @SuppressWarnings("unchecked")
    private String buildDynamicContextFromMemory(Novel novel, Map<String, Object> memoryBank, int chapterNumber) {
        StringBuilder context = new StringBuilder();
        
        // 1. è§’è‰²ä¿¡æ¯ï¼ˆåŠ¨æ€å‹ç¼©ï¼‰
        String characterSummary = characterManagementService.buildCharacterSummaryForWriting(
            novel.getId(), memoryBank, chapterNumber);
        if (!characterSummary.isEmpty()) {
            String compressedCharacters = compressCharacterInfoForPrompt(characterSummary);
            if (!compressedCharacters.isEmpty()) {
                context.append("ğŸ‘¥ ").append(compressedCharacters).append("\\n");
            }
        }
        
        // 2. å½“å‰å·ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        Object currentVolume = memoryBank.get("currentVolumeOutline");
        if (currentVolume instanceof Map) {
            Map<String, Object> volumeData = (Map<String, Object>) currentVolume;
            Object volumeTitle = volumeData.get("title");
            Object volumeTheme = volumeData.get("theme");
            if (volumeTitle != null || volumeTheme != null) {
                context.append("ğŸ“– å½“å‰å·ï¼š");
                if (volumeTitle != null) context.append(volumeTitle);
                if (volumeTheme != null) context.append(" - ").append(volumeTheme);
                context.append("\\n");
            }
        }
        
        // 3. ä¸–ç•Œè®¾å®šï¼ˆå…³é”®è¦ç‚¹ï¼‰
        Object worldSettings = memoryBank.get("worldSettings");
        if (worldSettings instanceof Map) {
            Map<String, Object> settings = (Map<String, Object>) worldSettings;
            StringBuilder worldInfo = new StringBuilder();
            Object powerSystem = settings.get("powerSystem");
            Object geography = settings.get("geography");
            if (powerSystem != null) worldInfo.append("åŠ›é‡ä½“ç³»: ").append(powerSystem).append("; ");
            if (geography != null) worldInfo.append("ç¯å¢ƒ: ").append(geography).append("; ");
            
            if (worldInfo.length() > 0) {
                context.append("ğŸŒ ").append(worldInfo.toString()).append("\\n");
            }
        }
        
        // 4. æ´»è·ƒæƒ…èŠ‚çº¿ï¼ˆç®€åŒ–ï¼‰
        Object plotThreads = memoryBank.get("plotThreads");
        if (plotThreads instanceof List) {
            List<Map<String, Object>> threads = (List<Map<String, Object>>) plotThreads;
            if (!threads.isEmpty()) {
                StringBuilder plotInfo = new StringBuilder("ğŸ§µ æ´»è·ƒçº¿ç´¢: ");
                int count = 0;
                for (Map<String, Object> thread : threads) {
                    if (count >= 3) break; // åªä¿ç•™å‰3ä¸ª
                    Object description = thread.get("description");
                    if (description != null) {
                        plotInfo.append(description).append("; ");
                        count++;
                    }
                }
                if (count > 0) {
                    context.append(plotInfo.toString()).append("\\n");
                }
            }
        }
        
        // 5. å…³é”®ä¼ç¬”ï¼ˆå½“å‰ç« èŠ‚ç›¸å…³ï¼‰
        Object foreshadowing = memoryBank.get("foreshadowing");
        if (foreshadowing instanceof Map) {
            Map<String, Object> foreshadowData = (Map<String, Object>) foreshadowing;
            Object activeHints = foreshadowData.get("activeHints");
            if (activeHints instanceof List) {
                List<Map<String, Object>> hints = (List<Map<String, Object>>) activeHints;
                StringBuilder hintInfo = new StringBuilder("ğŸ­ å½“å‰ä¼ç¬”: ");
                int count = 0;
                for (Map<String, Object> hint : hints) {
                    if (count >= 2) break; // åªä¿ç•™å‰2ä¸ª
                    Object description = hint.get("description");
                    if (description != null) {
                        hintInfo.append(description).append("; ");
                        count++;
                    }
                }
                if (count > 0) {
                    context.append(hintInfo.toString()).append("\\n");
                }
            }
        }
        
        return context.toString();
    }
    
    /**
     * åŠ¨æ€æ„å»ºåˆ›ä½œè€…èº«ä»½ï¼ˆåŸºäºå°è¯´ç±»å‹ï¼‰
     */
    private String buildDynamicCreatorIdentity(String genre) {
        StringBuilder identity = new StringBuilder();
        
        identity.append("ä½ æ˜¯ä¸€ä½èµ„æ·±ç½‘ç»œæ–‡å­¦åˆ›ä½œè€…ï¼Œä¸“æ³¨").append(genre).append("å°è¯´é¢†åŸŸåå¹´ä»¥ä¸Šã€‚\\n");
        
        // æ ¹æ®ç±»å‹é€‰æ‹©é£æ ¼å‚è€ƒ
        switch (genre) {
            case "ç„å¹»":
                identity.append("ä½ çš„å†™ä½œé£æ ¼èåˆçƒ½ç«æˆè¯¸ä¾¯çš„æ²‰éƒã€å¿˜è¯­çš„ç»†è…»ã€è¾°ä¸œçš„å®å¤§ã€‚\\n")
                        .append("ä½ æ“…é•¿ï¼šåŸ‹è®¾ä¼ç¬”ã€æ§åˆ¶èŠ‚å¥ã€å¡‘é€ çœŸå®äººç‰©ã€è¥é€ å‘½è¿æ„Ÿã€‚\\n")
                        .append("ä½ åå¯¹ï¼šç³»ç»Ÿæµã€æ— è„‘çˆ½æ–‡ã€é‡‘æ‰‹æŒ‡ç§’ç”Ÿæ•ˆã€è§’è‰²å·¥å…·åŒ–ã€‚");
                break;
            case "éƒ½å¸‚":
                identity.append("ä½ çš„å†™ä½œé£æ ¼èåˆå”å®¶ä¸‰å°‘çš„æµç•…ã€è¾°ä¸œçš„çˆ½å¿«ã€å¤©èš•åœŸè±†çš„èŠ‚å¥æ„Ÿã€‚\\n")
                        .append("ä½ æ“…é•¿ï¼šç°å®æ„Ÿæå†™ã€æƒ…æ„Ÿç»†è…»åˆ»ç”»ã€å•†æˆ˜æ™ºæ–—ã€éƒ½å¸‚ç”Ÿæ´»è´¨æ„Ÿã€‚\\n")
                        .append("ä½ åå¯¹ï¼šè¿‡åº¦è„±ç¦»ç°å®ã€è£…é€¼è¿‡åº¦ã€é‡‘æ‰‹æŒ‡å¤ªå‡ã€æ„Ÿæƒ…æˆæ‹–æ²“ã€‚");
                break;
            case "ä»™ä¾ ":
                identity.append("ä½ çš„å†™ä½œé£æ ¼èåˆæˆ‘åƒè¥¿çº¢æŸ¿çš„æ´’è„±ã€æ¢¦å…¥ç¥æœºçš„æ·±åº¦ã€å¿˜è¯­çš„ç»†è…»ã€‚\\n")
                        .append("ä½ æ“…é•¿ï¼šä¿®ä»™å“²ç†ã€å‰‘é“æ„å¢ƒã€æƒ…æ„Ÿå…‹åˆ¶ã€å¤é£éŸµå‘³ã€‚\\n")
                        .append("ä½ åå¯¹ï¼šä¿®ä»™å˜ä¿®çœŸã€å¢ƒç•Œæ··ä¹±ã€æ„Ÿæƒ…ç°ä»£åŒ–ã€å¤é£ä¸çº¯ã€‚");
                break;
            case "ç§‘å¹»":
                identity.append("ä½ çš„å†™ä½œé£æ ¼èåˆåˆ˜æ…ˆæ¬£çš„å®å¤§ã€ç‹æ™‹åº·çš„æ€è¾¨ã€ä½•å¤•çš„äººæ–‡å…³æ€€ã€‚\\n")
                        .append("ä½ æ“…é•¿ï¼šç§‘æŠ€è®¾å®šã€é€»è¾‘æ¨ç†ã€æœªæ¥æƒ³è±¡ã€äººæ€§æ€è€ƒã€‚\\n")
                        .append("ä½ åå¯¹ï¼šç§‘å­¦Bugã€é€»è¾‘çŸ›ç›¾ã€æŠ€æœ¯å †ç Œã€å¿½è§†äººæ–‡ã€‚");
                break;
            case "å†å²":
                identity.append("ä½ çš„å†™ä½œé£æ ¼èåˆæœˆå…³çš„è€ƒè¯ã€é…’å¾’çš„æ·±åº¦ã€å­‘ä¸2çš„å¹½é»˜ã€‚\\n")
                        .append("ä½ æ“…é•¿ï¼šå†å²è¿˜åŸã€æ”¿æ²»æ™ºè°‹ã€äººç‰©åˆ»ç”»ã€æ—¶ä»£æ°›å›´ã€‚\\n")
                        .append("ä½ åå¯¹ï¼šå†å²é”™è¯¯ã€ç°ä»£æ€ç»´ã€äººç‰©è„¸è°±åŒ–ã€æƒ…èŠ‚ç‹—è¡€ã€‚");
                break;
            case "å†›äº‹":
                identity.append("ä½ çš„å†™ä½œé£æ ¼èåˆçºµæ¨ªä¸­æ–‡çš„çƒ­è¡€ã€éª éª‘çš„ä¸“ä¸šã€åè¡¨çš„æ¿€æƒ…ã€‚\\n")
                        .append("ä½ æ“…é•¿ï¼šæˆ˜æœ¯æå†™ã€å†›äº‹ä¸“ä¸šã€å›¢é˜Ÿåˆä½œã€çˆ±å›½æƒ…æ€€ã€‚\\n")
                        .append("ä½ åå¯¹ï¼šå†›äº‹å¸¸è¯†é”™è¯¯ã€ä¸ªäººè‹±é›„ä¸»ä¹‰ã€è„±ç¦»å®é™…ã€æ”¿æ²»ä¸å½“ã€‚");
                break;
            default:
                identity.append("ä½ çš„å†™ä½œé£æ ¼æ³¨é‡æƒ…èŠ‚ç´§å‡‘ã€äººç‰©ç«‹ä½“ã€é€»è¾‘æ¸…æ™°ã€‚\\n")
                        .append("ä½ æ“…é•¿ï¼šèŠ‚å¥æ§åˆ¶ã€æ‚¬å¿µè®¾ç½®ã€è§’è‰²åˆ»ç”»ã€æƒ…æ„Ÿæ¸²æŸ“ã€‚\\n")
                        .append("ä½ åå¯¹ï¼šæ‹–æ²“å†—é•¿ã€äººç‰©æ‰å¹³ã€é€»è¾‘æ··ä¹±ã€æƒ…æ„Ÿè™šå‡ã€‚");
        }
        
        return identity.toString();
    }
    
    /**
     * åŠ¨æ€æ„å»ºåAIæ£€æµ‹è¦æ±‚ï¼ˆåŸºäºå°è¯´å…·ä½“ä¿¡æ¯ï¼‰
     */
    private String buildAntiAIDetectionRules(Novel novel, int chapterNumber) {
        StringBuilder rules = new StringBuilder();
        
        rules.append("**ã€ä¸¥æ ¼ç¦æ­¢Â·ä¼ªè´¨æ„Ÿé™·é˜±ã€‘**\\n");
        
        // é€šç”¨åAIæ£€æµ‹è§„åˆ™
        rules.append("â€¢ ç¦æ­¢å¼€å±€å¤šè§†è§’ï¼šç¡®ä¿è§†è§’èšç„¦æ˜ç¡®ï¼Œé¿å…æ··ä¹±è·³è½¬\\n")
             .append("â€¢ ç¦æ­¢ä¿¡æ¯è½°ç‚¸ï¼šé¿å…ä¸€æ¬¡æ€§å€¾å€’æ‰€æœ‰è®¾å®š\\n")
             .append("â€¢ ç¦æ­¢èƒ½åŠ›ç§’å¾—ï¼šåŠ›é‡è·å–å¿…é¡»æœ‰è¿‡ç¨‹ã€ä»£ä»·ã€ä¸ç¨³å®šæ€§\\n")
             .append("â€¢ ç¦æ­¢ç›´æ¥å‘½åï¼šé¿å…ä¸“ä¸šæœ¯è¯­æ»¡å¤©é£\\n")
             .append("â€¢ ç¦æ­¢åæ´¾è„¸è°±åŒ–ï¼šè¦æœ‰ç°å®é€»è¾‘å’Œå¤æ‚åŠ¨æœº\\n");
        
        // åŸºäºç±»å‹çš„ç‰¹å®šç¦å¿Œ
        String genre = novel.getGenre();
        switch (genre) {
            case "ç„å¹»":
                rules.append("â€¢ ç¦æ­¢ç³»ç»Ÿç±»è¯æ±‡ï¼š\"å®\"\"å®¿ä¸»\"\"ä»»åŠ¡\"\"å¥–åŠ±\"ç­‰\\n")
                     .append("â€¢ ç¦æ­¢å¢ƒç•Œç›´æ¥è¯´ï¼šç”¨æš—ç¤ºè€Œéæ˜ç¡®ç­‰çº§\\n");
                break;
            case "éƒ½å¸‚":
                rules.append("â€¢ ç¦æ­¢è¿‡åº¦è£…é€¼ï¼šæˆåŠŸè¦æœ‰åˆç†è¿‡ç¨‹\\n")
                     .append("â€¢ ç¦æ­¢è„±ç¦»ç°å®ï¼šä¿æŒéƒ½å¸‚ç”Ÿæ´»çœŸå®æ„Ÿ\\n");
                break;
            case "ä»™ä¾ ":
                rules.append("â€¢ ç¦æ­¢ç°ä»£ç”¨è¯­ï¼šä¿æŒå¤é£éŸµå‘³\\n")
                     .append("â€¢ ç¦æ­¢ä¿®çœŸæœ¯è¯­ï¼šç”¨ä¼ ç»Ÿä»™ä¾ æ¦‚å¿µ\\n");
                break;
        }
        
        // åŸºäºç« èŠ‚æ•°çš„ç‰¹å®šè¦æ±‚
        if (chapterNumber <= 3) {
            rules.append("â€¢ å¼€ç¯‡ç¦å¿Œï¼šé¿å…é‡‘æ‰‹æŒ‡ç›´æ¥æ˜¾ç°ã€åæ´¾ç«‹å³ç™»åœº\\n");
        } else if (chapterNumber <= 10) {
            rules.append("â€¢ åˆæœŸç¦å¿Œï¼šé¿å…åŠ›é‡æš´æ¶¨ã€è®¾å®šå…¨ç›˜æ›å…‰\\n");
        }
        
        return rules.toString();
    }
    
    /**
     * æ„å»ºæ·±åº¦åAIæ£€æµ‹æŠ€æœ¯ï¼ˆåŸºäºä¸“ä¸šæŒ‡å¯¼æ ¸å¿ƒï¼‰
     */
    private String buildAdvancedAntiAITechniques(Novel novel, int chapterNumber) {
        StringBuilder techniques = new StringBuilder();
        
        techniques.append("**ã€æ·±åº¦åAIæ£€æµ‹æŠ€æœ¯ã€‘**\n")
                 .append("### 1. çœŸå®æ„Ÿè¥é€ æŠ€å·§\n")
                 .append("- èº«ä½“ååº”å…·ä½“åŒ–ï¼šä¸è¯´'ç´§å¼ 'ï¼Œè€Œæ˜¯'æ‰‹å¿ƒå‡ºæ±—ï¼Œæ·±å‘¼å¸ä¸‰æ¬¡'\n")
                 .append("- åŠ¨ä½œå¾®è§‚åŒ–ï¼š'ä»–æ”¥ç´§äº†æ‹³å¤´'æ¯”'ä»–å¾ˆæ„¤æ€’'æ›´æœ‰åŠ›\n")
                 .append("- æ„Ÿå®˜å¯†åº¦å¢å¼ºï¼šåŒæ—¶è°ƒç”¨è§†è§‰ã€å¬è§‰ã€è§¦è§‰ã€å—…è§‰\n")
                 .append("- æ—¶é—´åˆ‡ç‰‡æŠ€æœ¯ï¼šç”¨'è¿™æ—¶''ä¸‹ä¸€åˆ»''å‡ ç§’å'åˆ›é€ èŠ‚å¥\n\n")
                 
                 .append("### 2. å¯¹è¯è‡ªç„¶åŒ–å¤„ç†\n")
                 .append("- ä¸å®Œæ•´å¥å¼ï¼š'è¿™ä¸ª...æ€ä¹ˆè¯´å‘¢''å—¯ï¼Œå¤§æ¦‚æ˜¯'\n")
                 .append("- åœé¡¿ä¸é‡å¤ï¼š'æˆ‘æ˜¯è¯´ï¼Œæˆ‘çš„æ„æ€æ˜¯...'\n")
                 .append("- ä¸ªäººè¯­è¨€ç‰¹è‰²ï¼šæ¯ä¸ªè§’è‰²æœ‰ä¸“å±å£å¤´ç¦…å’Œè¡¨è¾¾ä¹ æƒ¯\n")
                 .append("- æ½œå°è¯æŠ€å·§ï¼šè¯´ä¸€å¥è¯ï¼Œæš—ç¤ºå¦ä¸€å±‚æ„æ€\n\n")
                 
                 .append("### 3. æƒ…èŠ‚æ¨è¿›æŠ€æœ¯\n")
                 .append("- å†°å±±åŸç†ï¼šåªå±•ç°10%ï¼Œæš—ç¤º90%\n")
                 .append("- å»¶è¿Ÿæ»¡è¶³ï¼šå…³é”®ä¿¡æ¯åˆ†3æ¬¡é€éœ²\n")
                 .append("- æ„å¤–çš„é€»è¾‘æ€§ï¼šè½¬æŠ˜è¦çªç„¶ä½†å›å¤´çœ‹æœ‰é“ç†\n")
                 .append("- æƒ…ç»ªå…ˆè¡Œï¼šå…ˆè®©è¯»è€…æœ‰æƒ…ç»ªååº”ï¼Œå†è§£é‡ŠåŸå› \n\n");
        
        // åŸºäºç« èŠ‚é˜¶æ®µçš„ç‰¹æ®ŠæŠ€å·§
        if (chapterNumber <= 3) {
            techniques.append("### 4. å¼€ç¯‡é˜¶æ®µç‰¹æ®ŠæŠ€å·§\n")
                     .append("- è¯¯å¯¼æŠ€æœ¯ï¼šè®©ä¸»è§’å’Œè¯»è€…éƒ½è¯¯è§£æŸäº›ç°è±¡\n")
                     .append("- æ—¥å¸¸å¼‚å¸¸åŒ–ï¼šæŠŠå¹³å¸¸äº‹ç‰©å†™å¾—ç•¥å¾®ä¸å¯¹åŠ²\n")
                     .append("- é—®é¢˜å åŠ ï¼šæ¯ç« æœ«å°¾è¦å¤šä¸€ä¸ªç–‘é—®\n")
                     .append("- æƒ…æ„ŸæŠ•èµ„ï¼šè®©è¯»è€…å…ˆå…³å¿ƒè§’è‰²ï¼Œå†å…³å¿ƒæƒ…èŠ‚\n");
        } else if (chapterNumber <= 10) {
            techniques.append("### 4. å‘å±•é˜¶æ®µç‰¹æ®ŠæŠ€å·§\n")
                     .append("- èƒ½åŠ›ä¸ç¨³å®šï¼šæ—¶å¼ºæ—¶å¼±ï¼Œæœ‰å‰¯ä½œç”¨\n")
                     .append("- ç¤¾ä¼šæˆæœ¬ï¼šè·å¾—åŠ›é‡è¦ä»˜å‡ºç¤¾ä¼šå…³ç³»ä»£ä»·\n")
                     .append("- è®¤çŸ¥è¿·é›¾ï¼šä¸»è§’å¯¹è‡ªå·±çŠ¶å†µä¹Ÿä¸ç¡®å®š\n")
                     .append("- å±‚å±‚å‰¥å¼€ï¼šåƒå‰¥æ´‹è‘±ä¸€æ ·é€æ­¥æ­ç¤ºçœŸç›¸\n");
        }
        
        techniques.append("\n### 5. æ–‡é£å»AIåŒ–\n")
                 .append("- å¥å¼é•¿çŸ­æ··åˆï¼šé•¿å¥æŠ’æƒ…ï¼ŒçŸ­å¥ç´§å¼ \n")
                 .append("- é¿å…'çš„'å­—å¥ï¼š'è¡€çº¢çš„å¤•é˜³' â†’ 'å¤•é˜³çº¢å¾—åƒè¡€'\n")
                 .append("- åŠ¨è¯ä¼˜å…ˆï¼šç”¨åŠ¨è¯æ›¿ä»£å½¢å®¹è¯å’Œå‰¯è¯\n")
                 .append("- ç•™ç™½æŠ€å·§ï¼šé‡è¦æƒ…èŠ‚åè¦æœ‰åœé¡¿æ„Ÿ\n");
        
        return techniques.toString();
    }
    
    /**
     * è·å–å¢å¼ºçš„ç±»å‹ç‰¹å®šæŒ‡å¯¼ï¼ˆæ›´è‡ªç„¶çš„å†™ä½œé£æ ¼ï¼‰
     */
    private String getEnhancedGenreGuidance(String genre, int chapterNumber) {
        StringBuilder guidance = new StringBuilder();
        
        switch (genre) {
            case "éƒ½å¸‚":
                guidance.append("â€¢ æå†™è¦è´´è¿‘ç°å®ä½†æœ‰æˆå‰§æ€§ï¼Œé¿å…è¿‡äºå¹³æ·¡\\n")
                        .append("â€¢ å•†ä¸šã€æƒ…æ„Ÿã€æˆé•¿ä¸‰çº¿å¹¶è¡Œï¼Œäº’ç›¸å½±å“\\n")
                        .append("â€¢ ä¸»è§’èƒ½åŠ›è¦åˆç†ï¼ŒæˆåŠŸæœ‰è¿‡ç¨‹ä¸èƒ½å¤ªçªå…€\\n")
                        .append("â€¢ é…è§’è¦æœ‰è¡€æœ‰è‚‰ï¼Œä¸æ˜¯å·¥å…·äººï¼Œæœ‰è‡ªå·±çš„ç›®æ ‡\\n")
                        .append("â€¢ å†²çªæ¥æºäºç°å®ï¼šåˆ©ç›Šã€æƒ…æ„Ÿã€ä»·å€¼è§‚å·®å¼‚\\n");
                break;
            case "ç„å¹»":
                guidance.append("â€¢ ä¿®ç‚¼è¦æœ‰æ„Ÿæ‚Ÿè¿‡ç¨‹ï¼Œä¸åªæ˜¯æ‰“åå¸æ”¶\\n")
                        .append("â€¢ æˆ˜æ–—è¦æœ‰æˆ˜æœ¯ï¼Œä¸æ˜¯çº¯ç²¹çš„åŠ›é‡ç¢¾å‹\\n")
                        .append("â€¢ å®ç‰©å’Œæœºç¼˜è¦æœ‰ä»£ä»·ï¼Œå¤©ä¸Šä¸ä¼šæ‰é¦…é¥¼\\n")
                        .append("â€¢ å¢ƒç•Œæå‡è¦å½±å“æ€§æ ¼å’Œè®¤çŸ¥ï¼Œä¸åªæ˜¯åŠ›é‡\\n")
                        .append("â€¢ åŠ¿åŠ›å…³ç³»è¦å¤æ‚ï¼Œæœ‰åŒç›Ÿæœ‰æ•Œå¯¹æœ‰ä¸­ç«‹\\n");
                break;
            case "ç§‘å¹»":
                guidance.append("â€¢ ç§‘æŠ€è¦æœ‰é€»è¾‘åŸºç¡€ï¼Œä¸èƒ½è¿èƒŒåŸºæœ¬ç‰©ç†\\n")
                        .append("â€¢ æœªæ¥ç¤¾ä¼šè¦æœ‰å†å²è¿›ç¨‹ï¼Œä¸æ˜¯å‡­ç©ºå‡ºç°\\n")
                        .append("â€¢ äººç‰©å…³ç³»è¦è€ƒè™‘ç§‘æŠ€å¯¹ç¤¾ä¼šç»“æ„çš„å½±å“\\n")
                        .append("â€¢ å†²çªè¦ä¸ç§‘æŠ€å‘å±•æ°´å¹³ç›¸åŒ¹é…\\n")
                        .append("â€¢ æ¢ç´¢æœªçŸ¥è¦æœ‰é£é™©ï¼Œä¸æ˜¯è½»æ¾æ—…æ¸¸\\n");
                break;
            case "å†å²":
                guidance.append("â€¢ å†å²ç»†èŠ‚è¦è€ƒç©¶ï¼Œæœè£…ã€å»ºç­‘ã€ç¤¾ä¼šåˆ¶åº¦\\n")
                        .append("â€¢ äººç‰©æ€ç»´è¦ç¬¦åˆæ—¶ä»£èƒŒæ™¯\\n")
                        .append("â€¢ æ”¿æ²»æ–—äº‰è¦æœ‰å±‚æ¬¡ï¼Œä¸åªæ˜¯ä½ æ­»æˆ‘æ´»\\n")
                        .append("â€¢ æˆ˜äº‰æå†™è¦çœŸå®æ®‹é…·ï¼Œæœ‰ç­–ç•¥æœ‰ç‰ºç‰²\\n")
                        .append("â€¢ æ–‡åŒ–å·®å¼‚è¦ä½“ç°åœ¨æ—¥å¸¸ç»†èŠ‚ä¸­\\n");
                break;
            case "ä»™ä¾ ":
                guidance.append("â€¢ ä¿®ä»™è¦æœ‰å“²å­¦æ€è€ƒï¼Œä¸åªæ˜¯å˜å¼º\\n")
                        .append("â€¢ é—¨æ´¾å…³ç³»è¦å¤æ‚ï¼Œæœ‰ä¼ æ‰¿æœ‰ç«äº‰\\n")
                        .append("â€¢ å¤©é“è§„åˆ™è¦ä¸€è‡´ï¼Œä¸èƒ½éšæ„æ›´æ”¹\\n")
                        .append("â€¢ æƒ…æ„Ÿè¦å…‹åˆ¶å«è“„ï¼Œç¬¦åˆä»™ä¾ æ°›å›´\\n")
                        .append("â€¢ æ‰“æ–—è¦æœ‰æ„å¢ƒï¼Œä¸åªæ˜¯æ‹›å¼å¯¹æ’\\n");
                break;
            default:
                guidance.append("â€¢ ä¿æŒç±»å‹ç‰¹è‰²çš„åŒæ—¶è¦æœ‰åˆ›æ–°\\n")
                        .append("â€¢ äººç‰©åˆ»ç”»è¦ç«‹ä½“ï¼Œæœ‰ä¼˜ç¼ºç‚¹\\n")
                        .append("â€¢ æƒ…èŠ‚å‘å±•è¦æœ‰å› æœå…³ç³»\\n")
                        .append("â€¢ å¯¹è¯è¦æ¨è¿›æƒ…èŠ‚æˆ–æ­ç¤ºæ€§æ ¼\\n");
        }
        
        return guidance.toString();
    }
    
    /**
     * è·å–æ·±åº¦ç±»å‹æŒ‡å¯¼ï¼ˆåŸºäºä¸“ä¸šè¯„ä»·å…¨æ–°è®¾è®¡ï¼‰
     */
    private String getAdvancedGenreGuidance(String genre, int chapterNumber) {
        StringBuilder guidance = new StringBuilder();
        
        // ç‰¹åˆ«å¤„ç†æ—©æœŸç« èŠ‚çš„ç¥ç§˜æ„Ÿè¥é€ 
        boolean isEarlyChapter = chapterNumber <= 10;
        
        switch (genre) {
            case "éƒ½å¸‚":
                guidance.append("â€¢ **ç°å®æ„ŸåŸºç¡€**ï¼šä»çœŸå®çš„ç”Ÿæ´»ç»†èŠ‚å¼€å§‹ï¼Œé€æ­¥åŸ‹å…¥ç¥ç§˜å…ƒç´ \\n")
                        .append("â€¢ **åæ´¾å¤æ‚åŒ–**ï¼šä¸ç›´æ¥ä¼¤å®³ï¼Œè€Œæ˜¯ç”¨æ³•å¾‹ã€ç»æµã€ç¤¾ä¼šå…³ç³»æ–½å‹\\n")
                        .append("â€¢ **åŠ›é‡è§‰é†’**ï¼šä¸æ˜¯çªç„¶è·å¾—è¶…èƒ½åŠ›ï¼Œè€Œæ˜¯ç›´è§‰ã€çµæ•ã€åˆ¤æ–­åŠ›çš„æå‡\\n")
                        .append("â€¢ **ç”Ÿæ´»è´¨æ„Ÿ**ï¼šå…·ä½“åœ°åã€ç‰©ä»·ã€äº¤é€šã€å·¥ä½œç»†èŠ‚è¦çœŸå®\\n");
                if (isEarlyChapter) {
                    guidance.append("â€¢ **å¼€ç¯‡é‡ç‚¹**ï¼šä¸»è§’é‡åˆ°ä¸€ä¸ªå°å¼‚å¸¸ï¼Œä½†ä»¥ä¸ºæ˜¯å·§åˆ\\n")
                            .append("â€¢ **ç¦æ­¢**ï¼šå¼€ç¯‡å°±æ˜ç¤ºä¸»è§’æœ‰ç‰¹æ®Šèƒ½åŠ›æˆ–ç¥ç§˜èº«ä»½\\n");
                }
                break;
                
            case "ç„å¹»":
                guidance.append("â€¢ **ç¥ç§˜ç°è±¡ç¢ç‰‡åŒ–**ï¼šé€šè¿‡æ„Ÿå®˜å¼‚å¸¸ã€æ¢¦å¢ƒã€è®°å¿†é—ªå›æš—ç¤º\\n")
                        .append("â€¢ **ç¦æ­¢ç›´æ¥å‘½å**ï¼šä¸è¯´\"ä¿®ä»™\"\"çœŸæ°”\"\"çµæ ¹\"ï¼Œç”¨æ°‘é—´è¯´æ³•\\n")
                        .append("â€¢ **å¼‚ç‰©ä¸è§£é‡Š**ï¼šé“œé•œã€ç‰ç®ã€å¤ä¹¦åªæ˜¾ç°å¼‚è±¡ï¼Œä¸è¯´æ˜åŠŸèƒ½\\n")
                        .append("â€¢ **åŠ›é‡ä¸ç¨³å®š**ï¼šæ—¶æœ‰æ—¶æ— ã€éš¾ä»¥æ§åˆ¶ã€æœ‰å‰¯ä½œç”¨\\n")
                        .append("â€¢ **è§‰é†’ä»£ä»·**ï¼šå¿…é¡»æœ‰èº«ä½“ç—›è‹¦ã€ç²¾ç¥æ­£å¸¸ã€ç¤¾ä¼šéš”é˜™\\n");
                if (isEarlyChapter) {
                    guidance.append("â€¢ **æ—©æœŸåŸåˆ™**ï¼šæ—¥å¸¸å›°å¢ƒ + ä¸€ä¸ªä»¤äººç–‘æƒ‘çš„ç»†èŠ‚\\n")
                            .append("â€¢ **ä¸¥ç¦**ï¼šç³»ç»Ÿã€å™¨çµã€å¤©é€‰ä¹‹å­ç­‰å¥—è·¯è¡¨è¾¾\\n")
                            .append("â€¢ **ç›®æ ‡**ï¼š3ä¸ªç–‘é—® + 1ä¸ªç˜¦æƒ… + 0ä¸ªè§£ç­”\\n");
                }
                break;
                
            case "ä»™ä¾ ":
                guidance.append("â€¢ **é“æ³•å“²å­¦**ï¼šä¸ç›´æ¥è¯´æ•™ï¼Œé€šè¿‡è¡Œä¸ºå’Œé€‰æ‹©ä½“ç°\\n")
                        .append("â€¢ **å¤é£æ„å¢ƒ**ï¼šæ–‡è¨€è¯æ±‡ã€ç®€æ´å¯¹è¯ã€æ„å¢ƒä¼ é€’\\n")
                        .append("â€¢ **æƒ…æ„Ÿå…‹åˆ¶**ï¼šæƒ…ç”±å¿ƒç”Ÿä½†ä¸ç›´ç™½ï¼Œæ— ç°ä»£æ€å£è¯­\\n")
                        .append("â€¢ **æˆ˜æ–—ç¾å­¦**ï¼šæ‹›å¼åç§°ã€åŠ¨ä½œæå†™ã€æ„å¢ƒçƒ˜æ‰˜å¹¶é‡\\n");
                if (isEarlyChapter) {
                    guidance.append("â€¢ **å¼€ç¯‡æ°›å›´**ï¼šå¤æœ´å®é™ç¯å¢ƒ + è¿œå±±å¦‚å¢¨ + ä¸€ä¸ç•°è±¡\\n");
                }
                break;
                
            case "ç§‘å¹»":
                guidance.append("â€¢ **ç§‘å­¦é€»è¾‘**ï¼šè®¾å®šä¸èƒ½è¿ååŸºæœ¬ç‰©ç†å®šå¾‹\\n")
                        .append("â€¢ **æœªæ¥è´¨æ„Ÿ**ï¼šæœ‰å˜åŒ–ä½†ä¸å¤±çœŸï¼Œä»Šå¤©+50å¹´çš„æ„Ÿè§‰\\n")
                        .append("â€¢ **äººæ–‡å…³æ€€**ï¼šç§‘æŠ€å‘å±•å¯¹äººæ€§ã€ä¼¦ç†ã€ç¤¾ä¼šçš„å†²å‡»\\n")
                        .append("â€¢ **æœªçŸ¥æƒŠæ‚š**ï¼šå¯¹æœªæ¥çš„ææƒ§å’Œå¯¹æœªçŸ¥çš„æ•æ„Ÿ\\n");
                if (isEarlyChapter) {
                    guidance.append("â€¢ **å¼€ç¯‡æ„è±¡**ï¼šæ—¥å¸¸æœªæ¥ç”Ÿæ´» + ä¸€ä¸ªè®©äººä¸å®‰çš„ç»†èŠ‚\\n");
                }
                break;
                
            default:
                guidance.append("â€¢ **ç±»å‹è´¨æ„Ÿ**ï¼šç¬¦åˆç±»å‹æœŸå¾…ä½†é¿å…å¥—è·¯åŒ–\\n")
                        .append("â€¢ **äººç‰©ç«‹ä½“**ï¼šæ¯ä¸ªè§’è‰²éƒ½æœ‰ä¸ªäººåŠ¨æœºå’Œç›²ç‚¹\\n")
                        .append("â€¢ **å› æœé€»è¾‘**ï¼šæƒ…èŠ‚å‘å±•è¦æœ‰æ¸…æ™°çš„å› æœé“¾\\n");
        }
        
        // ç« èŠ‚æ•°ç‰¹æ®ŠæŒ‡å¯¼
        if (chapterNumber <= 3) {
            guidance.append("\\nğŸ“ **å¼€ç¯‡é»„é‡‘æ³•åˆ™**ï¼š\\n")
                    .append("- æ—¥å¸¸ç”Ÿæ´»åŸºè°ƒ + ä¸€ä¸ªä»¤äººç–‘æƒ‘çš„ç»†èŠ‚\\n")
                    .append("- ä¸»è§’æœ‰å†…å¿ƒæ¸´æœ›ä½†ä¸æ˜¯è¶…èƒ½åŠ›\\n")
                    .append("- è®©è¯»è€…åœ¨ç¬¬3ç« ç»“æŸæ—¶äº§ç”Ÿ3ä¸ªç–‘é—®\\n");
        } else if (chapterNumber <= 10) {
            guidance.append("\\nğŸ“ **åˆæœŸå‘å±•åŸåˆ™**ï¼š\\n")
                    .append("- ä¸è§£é‡Šå‰é¢çš„ç–‘é—®ï¼Œåè€Œå¢åŠ æ–°çš„è°œå›¢\\n")
                    .append("- ä¸»è§’å˜åŒ–ä¸æ˜æ˜¾ä½†è¯»è€…èƒ½æ„ŸçŸ¥åˆ°\\n")
                    .append("- åŸ‹è®¾å…³é”®é…è§’å’Œç¯å¢ƒï¼Œä¸ºåç»­åšé“ºå«\\n");
        }
        
        guidance.append("\\n");
        return guidance.toString();
    }
}