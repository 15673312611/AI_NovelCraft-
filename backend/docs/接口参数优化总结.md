# æ¥å£å‚æ•°ä¼˜åŒ–æ€»ç»“

## ğŸ“‹ ä¼˜åŒ–å†…å®¹

### é—®é¢˜
ç”¨æˆ·åé¦ˆï¼šç”Ÿæˆå·çº§ç« çº²æ¥å£çš„å‚æ•°ç»“æ„ä¸åˆç†
- âŒ åŸå‚æ•°åŒ…å« `temperature`ã€`maxTokens` ç­‰å‰ç«¯ä¸åº”å…³å¿ƒçš„å‚æ•°
- âŒ å‚æ•°ç»“æ„ä¸å…¶ä»–æ¥å£ï¼ˆå¦‚ `/agentic/graph/regenerate-metadata`ï¼‰ä¸ä¸€è‡´

### è§£å†³æ–¹æ¡ˆ
å‚è€ƒ `/agentic/graph/regenerate-metadata` æ¥å£ï¼Œç»Ÿä¸€ä½¿ç”¨æ‰å¹³åŒ–çš„ AI é…ç½®å‚æ•°ï¼š
- âœ… `provider`: AI æœåŠ¡å•†ï¼ˆopenaiã€deepseekã€qwenã€kimi ç­‰ï¼‰
- âœ… `apiKey`: API å¯†é’¥
- âœ… `model`: æ¨¡å‹åç§°
- âœ… `baseUrl`: API åŸºç¡€ URLï¼ˆå¯é€‰ï¼‰
- âœ… åç«¯é»˜è®¤ `maxTokens=16000`ã€`temperature=0.8`ï¼Œå‰ç«¯æ— éœ€ä¼ é€’

---

## ğŸ”§ ä¿®æ”¹å†…å®¹

### 1. Controller ä¿®æ”¹

**æ–‡ä»¶**: `backend/src/main/java/com/novel/controller/VolumeChapterOutlineController.java`

#### ä¿®æ”¹å‰

```java
@PostMapping("/{volumeId}/chapter-outlines/generate")
public ResponseEntity<?> generateChapterOutlines(
        @PathVariable("volumeId") Long volumeId,
        @RequestBody(required = false) GenerateRequest body
) {
    if (body == null) body = new GenerateRequest();
    Integer count = body.getCount() != null ? body.getCount() : 50;
    AIConfigRequest ai = body.getAiConfig();
    // ...
}

public static class GenerateRequest {
    private Integer count;
    private Boolean includeDecisionLog;
    private AIConfigRequest aiConfig; // åµŒå¥—å¯¹è±¡
    // ...
}
```

#### ä¿®æ”¹å

```java
@PostMapping("/{volumeId}/chapter-outlines/generate")
public ResponseEntity<?> generateChapterOutlines(
        @PathVariable("volumeId") Long volumeId,
        @RequestBody(required = false) Map<String, Object> request
) {
    // è§£æå‚æ•°
    Integer count = null;
    Boolean includeDecisionLog = false;
    
    if (request != null) {
        if (request.containsKey("count") && request.get("count") != null) {
            count = ((Number) request.get("count")).intValue();
        }
        if (request.containsKey("includeDecisionLog") && request.get("includeDecisionLog") != null) {
            includeDecisionLog = (Boolean) request.get("includeDecisionLog");
        }
    }
    
    // æå– AI é…ç½®ï¼ˆæ‰å¹³åŒ–å‚æ•°ï¼‰
    AIConfigRequest aiConfig = extractAIConfig(request);
    // ...
}

/**
 * ä»è¯·æ±‚ä¸­æå– AI é…ç½®
 * æ”¯æŒæ‰å¹³åŒ–å‚æ•°ï¼ˆproviderã€apiKeyã€modelã€baseUrlï¼‰
 * å‚è€ƒ GraphManagementController.extractAIConfig
 */
private AIConfigRequest extractAIConfig(Map<String, Object> request) {
    if (request == null) {
        return null;
    }

    // ä¼˜å…ˆä»æ ¹çº§åˆ«è¯»å–æ‰å¹³åŒ–å‚æ•°
    Object providerObj = request.get("provider");
    Object apiKeyObj = request.get("apiKey");
    Object modelObj = request.get("model");
    Object baseUrlObj = request.get("baseUrl");

    if (providerObj instanceof String || apiKeyObj instanceof String || 
        modelObj instanceof String || baseUrlObj instanceof String) {
        AIConfigRequest config = new AIConfigRequest();
        if (providerObj instanceof String) {
            config.setProvider(((String) providerObj).trim());
        }
        if (apiKeyObj instanceof String) {
            config.setApiKey(((String) apiKeyObj).trim());
        }
        if (modelObj instanceof String) {
            config.setModel(((String) modelObj).trim());
        }
        if (baseUrlObj instanceof String) {
            config.setBaseUrl(((String) baseUrlObj).trim());
        }
        return config;
    }

    // å…¼å®¹åµŒå¥—çš„ aiConfig å¯¹è±¡ï¼ˆå‘åå…¼å®¹ï¼‰
    @SuppressWarnings("unchecked")
    Map<String, Object> aiConfigMap = request.get("aiConfig") instanceof Map ? 
        (Map<String, Object>) request.get("aiConfig") : null;
    if (aiConfigMap != null) {
        AIConfigRequest config = new AIConfigRequest();
        // ... è§£æåµŒå¥—å¯¹è±¡
        return config;
    }

    return null;
}
```

**å…³é”®æ”¹è¿›**:
1. ä½¿ç”¨ `Map<String, Object>` æ¥æ”¶è¯·æ±‚ä½“ï¼Œæ›´çµæ´»
2. æ”¯æŒæ‰å¹³åŒ–å‚æ•°ï¼ˆproviderã€apiKeyã€modelã€baseUrlï¼‰
3. å…¼å®¹åµŒå¥—çš„ `aiConfig` å¯¹è±¡ï¼ˆå‘åå…¼å®¹ï¼‰
4. å‚è€ƒ `GraphManagementController.extractAIConfig` çš„å®ç°

---

### 2. æ–‡æ¡£ä¿®æ”¹

**æ–‡ä»¶**: `backend/docs/api_examples/generate_volume_chapter_outlines.md`

#### ä¿®æ”¹å‰

```json
{
  "includeDecisionLog": true,
  "aiConfig": {
    "model": "gpt-4o",
    "temperature": 0.8,
    "maxTokens": 8000
  }
}
```

#### ä¿®æ”¹å

```json
{
  "provider": "openai",
  "apiKey": "sk-xxx",
  "model": "gpt-4o",
  "baseUrl": "https://api.openai.com/v1",
  "includeDecisionLog": true
}
```

**å…³é”®æ”¹è¿›**:
1. ç§»é™¤ `temperature`ã€`maxTokens` å‚æ•°ï¼ˆåç«¯é»˜è®¤ï¼‰
2. ä½¿ç”¨æ‰å¹³åŒ–å‚æ•°ï¼ˆproviderã€apiKeyã€modelã€baseUrlï¼‰
3. ä¸ `/agentic/graph/regenerate-metadata` æ¥å£ä¿æŒä¸€è‡´

---

## ğŸ“Š å‚æ•°å¯¹æ¯”

### ä¿®æ”¹å‰

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `count` | Integer | å¦ | ç”Ÿæˆç« æ•° |
| `includeDecisionLog` | Boolean | å¦ | æ˜¯å¦åŒ…å«å†³ç­–æ—¥å¿— |
| `aiConfig.model` | String | æ˜¯ | æ¨¡å‹åç§° |
| `aiConfig.temperature` | Double | å¦ | æ¸©åº¦å‚æ•° |
| `aiConfig.maxTokens` | Integer | å¦ | æœ€å¤§ token æ•° |
| `aiConfig.apiKey` | String | æ˜¯ | API å¯†é’¥ |

**é—®é¢˜**:
- âŒ åµŒå¥—ç»“æ„ï¼Œå‰ç«¯éœ€è¦æ„é€  `aiConfig` å¯¹è±¡
- âŒ `temperature`ã€`maxTokens` å‰ç«¯ä¸åº”å…³å¿ƒ
- âŒ ç¼ºå°‘ `provider`ã€`baseUrl` å‚æ•°

### ä¿®æ”¹å

| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| `provider` | String | æ˜¯ | - | AI æœåŠ¡å•†ï¼ˆopenaiã€deepseekã€qwenã€kimiï¼‰ |
| `apiKey` | String | æ˜¯ | - | API å¯†é’¥ |
| `model` | String | æ˜¯ | - | æ¨¡å‹åç§° |
| `baseUrl` | String | å¦ | æ ¹æ® provider æ¨æ–­ | API åŸºç¡€ URL |
| `count` | Integer | å¦ | è‡ªåŠ¨è®¡ç®— | ç”Ÿæˆç« æ•° |
| `includeDecisionLog` | Boolean | å¦ | false | æ˜¯å¦åŒ…å«å†³ç­–æ—¥å¿— |

**ä¼˜åŠ¿**:
- âœ… æ‰å¹³åŒ–ç»“æ„ï¼Œå‰ç«¯ç›´æ¥ä¼ é€’å‚æ•°
- âœ… åç«¯é»˜è®¤ `maxTokens=16000`ã€`temperature=0.8`
- âœ… æ”¯æŒå¤šç§ AI æœåŠ¡å•†ï¼ˆproviderï¼‰
- âœ… ä¸å…¶ä»–æ¥å£ä¿æŒä¸€è‡´

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ä½¿ç”¨ OpenAI

```bash
curl -X POST http://localhost:8080/api/volumes/123/chapter-outlines/generate \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "openai",
    "apiKey": "sk-xxx",
    "model": "gpt-4o",
    "baseUrl": "https://api.openai.com/v1"
  }'
```

### ä½¿ç”¨ DeepSeek

```bash
curl -X POST http://localhost:8080/api/volumes/123/chapter-outlines/generate \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "deepseek",
    "apiKey": "sk-xxx",
    "model": "deepseek-chat",
    "baseUrl": "https://api.deepseek.com"
  }'
```

### ä½¿ç”¨é€šä¹‰åƒé—®

```bash
curl -X POST http://localhost:8080/api/volumes/123/chapter-outlines/generate \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "qwen",
    "apiKey": "sk-xxx",
    "model": "qwen-max",
    "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1"
  }'
```

### ä½¿ç”¨ Kimi

```bash
curl -X POST http://localhost:8080/api/volumes/123/chapter-outlines/generate \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "kimi",
    "apiKey": "sk-xxx",
    "model": "moonshot-v1-8k"
  }'
```

**è¯´æ˜**:
- `baseUrl` å¯é€‰ï¼Œä¸ä¼ åˆ™æ ¹æ® `provider` è‡ªåŠ¨æ¨æ–­
- `count` å¯é€‰ï¼Œä¸ä¼ åˆ™æŒ‰å·çš„ `chapterStart/chapterEnd` è‡ªåŠ¨è®¡ç®—

---

## ğŸ“ åç«¯é»˜è®¤å€¼

### maxTokens

```java
// VolumeChapterOutlineService.java
private static final int DEFAULT_MAX_TOKENS = 16000;
```

**ç†ç”±**:
- ç”Ÿæˆ 50 ç« ç« çº²ï¼Œæ¯ç« çº¦ 200-300 tokens
- æ€»è®¡çº¦ 10000-15000 tokens
- 16000 tokens è¶³å¤Ÿç”Ÿæˆå®Œæ•´ç« çº²

### temperature

```java
// VolumeChapterOutlineService.java
private static final double DEFAULT_TEMPERATURE = 0.8;
```

**ç†ç”±**:
- 0.8 é€‚åˆåˆ›æ„å†™ä½œ
- æ—¢ä¿è¯åˆ›æ„æ€§ï¼Œåˆä¸ä¼šè¿‡äºå‘æ•£

---

## ğŸ”„ å‘åå…¼å®¹

Controller ä»æ”¯æŒåµŒå¥—çš„ `aiConfig` å¯¹è±¡ï¼ˆå‘åå…¼å®¹ï¼‰ï¼š

```json
{
  "aiConfig": {
    "provider": "openai",
    "apiKey": "sk-xxx",
    "model": "gpt-4o",
    "baseUrl": "https://api.openai.com/v1"
  }
}
```

ä½†**æ¨èä½¿ç”¨æ‰å¹³åŒ–å‚æ•°**ï¼Œä¸å…¶ä»–æ¥å£ä¿æŒä¸€è‡´ã€‚

---

## âœ… ç¼–è¯‘çŠ¶æ€

**ç¼–è¯‘æˆåŠŸ** - æ‰€æœ‰ä»£ç å·²ç¼–è¯‘é€šè¿‡ï¼Œå¯ä»¥ç›´æ¥æµ‹è¯•ï¼

---

## ğŸ“Œ æ€»ç»“

1. **å‚æ•°ç»“æ„ä¼˜åŒ–**
   - ç§»é™¤ `temperature`ã€`maxTokens` å‚æ•°ï¼ˆåç«¯é»˜è®¤ï¼‰
   - ä½¿ç”¨æ‰å¹³åŒ–å‚æ•°ï¼ˆproviderã€apiKeyã€modelã€baseUrlï¼‰
   - ä¸ `/agentic/graph/regenerate-metadata` æ¥å£ä¿æŒä¸€è‡´

2. **åç«¯é»˜è®¤å€¼**
   - `maxTokens=16000`ï¼ˆè¶³å¤Ÿç”Ÿæˆ 50 ç« ç« çº²ï¼‰
   - `temperature=0.8`ï¼ˆé€‚åˆåˆ›æ„å†™ä½œï¼‰

3. **å‘åå…¼å®¹**
   - ä»æ”¯æŒåµŒå¥—çš„ `aiConfig` å¯¹è±¡
   - æ¨èä½¿ç”¨æ‰å¹³åŒ–å‚æ•°

4. **æ–‡æ¡£æ›´æ–°**
   - æ›´æ–°æ¥å£è°ƒç”¨ç¤ºä¾‹
   - æ·»åŠ å¤šç§ AI æœåŠ¡å•†ç¤ºä¾‹
   - æ·»åŠ å‚æ•°è¯´æ˜è¡¨æ ¼

---

## ğŸ—‚ï¸ ç›¸å…³æ–‡ä»¶

- `backend/src/main/java/com/novel/controller/VolumeChapterOutlineController.java` - Controller ä¿®æ”¹
- `backend/docs/api_examples/generate_volume_chapter_outlines.md` - æ–‡æ¡£æ›´æ–°
- `backend/sql/volume_chapter_outlines_and_foreshadow_lifecycle.sql` - SQL å»ºè¡¨è¯­å¥ï¼ˆå·²æœ‰ï¼‰

