# 章纲写作架构优化总结

## 📋 问题分析

### 用户提出的核心问题

> "章纲内容太短了，可能缺失一些参考的，如果没有一些上下文，AI能写的范围也太小"

### 发现的问题

1. **原 `buildMessagesFromIntent` 提示词过于简陋**
   - ❌ 只有：System prompt + 小说基础信息 + 状态硬约束 + 章节意图 + 字数限制
   - ❌ 缺失：核心设定、卷蓝图、图谱上下文、最近章节、角色档案

2. **对比 `buildMessagesForDirectWriting`（完整版）**
   - ✅ 包含：System prompt + 小说基础信息 + 核心设定 + 卷蓝图 + 最近章节 + 角色档案 + 状态硬约束 + 图谱上下文 + 用户调整 + 写作任务 + 字数限制

3. **用户担忧完全正确**
   - "如果只用章纲，不加系统精简大纲，会不会容易偏离原本风格？" → **会！**
   - 没有核心设定 → AI 不知道世界观规则
   - 没有卷蓝图 → AI 不知道本卷目标和节奏
   - 没有图谱上下文 → AI 不知道历史事件和伏笔
   - 没有角色档案 → AI 不知道人物性格和关系
   - 没有最近章节 → AI 不知道前文剧情

4. **结果：AI 只能根据章纲"盲写"**
   - 偏离原本风格
   - 违背世界观规则
   - 人物性格不一致
   - 与前文剧情脱节
   - 忽略重要伏笔

---

## ✅ 解决方案

### 架构：**章纲（方向） + 完整上下文（约束和细节）**

```
章纲（direction）：主角在拍卖会上竞拍神秘丹药
+
核心设定：修仙世界，丹药分九品，主角目前筑基期
+
卷蓝图：本卷目标是突破金丹期，主线是收集筑基丹材料
+
图谱：上一章主角得知拍卖会有筑基丹，女主角暗中跟踪
+
角色档案：主角性格谨慎、低调，女主角好奇心强
+
最近章节：第49章主角在黑市打听到拍卖会消息
=
AI 能写出：符合世界观、人设一致、剧情连贯、有伏笔的高质量章节
```

### 新的消息结构（12条消息）

| 序号 | 角色 | 内容 | 作用 |
|------|------|------|------|
| 1 | system | 基础写作规则 + 风格 | 定义AI角色和写作风格 |
| 2 | system | 小说基础信息 | 书名、题材、简介 |
| 3 | system | 核心设定 | 世界观、力量体系、规则 |
| 4 | system | 卷蓝图 | 本卷目标、主线、节奏 |
| 5 | system | 最近章节完整内容和概要 | 前文剧情、衔接点 |
| 6 | system | 角色档案 | 人物性格、关系、状态 |
| 7 | system | 状态硬约束 | 核心记忆账本、不可违背的事实 |
| 8 | system | 图谱上下文 | 历史事件、伏笔、节奏 |
| 9 | user | 本章创作方向 | 剧情方向、关键剧情点、伏笔操作、支线、对抗 |
| 10 | user | 写作任务说明 | 具体要求（衔接、人设、世界规则、推进剧情） |
| 11 | user | 字数限制 | 目标字数、上限 |
| 12 | user | 执行指令 | 开始创作 |

---

## 🔧 代码修改

### 修改文件：`backend/src/main/java/com/novel/agentic/service/StructuredMessageBuilder.java`

#### 修改前（简陋版）

```java
public List<Map<String, String>> buildMessagesFromIntent(...) {
    // 1. System prompt
    // 2. 小说基础信息（只有书名）
    // 3. 状态硬约束
    // 4. 章节意图（JSON）
    // 5. 字数限制
    // 6. 执行指令
    return messages; // 只有6条消息
}
```

#### 修改后（完整版）

```java
/**
 * 🆕 从推理意图（plotIntent JSON）构建写作消息
 * 替代原来的"推理 → 生成Markdown章纲 → 写作"流程
 * 
 * 架构：章纲（方向） + 完整上下文（约束和细节）
 * - 章纲提供：本章剧情方向、关键剧情点、伏笔操作
 * - 上下文提供：核心设定、卷蓝图、图谱、角色档案、最近章节
 * - 确保：符合世界观、人设一致、剧情连贯、有伏笔
 */
public List<Map<String, String>> buildMessagesFromIntent(...) {
    // Message 1: System - 基础写作规则 + 风格
    // Message 2: 小说基础信息
    // Message 3: 核心设定（如果有）
    // Message 4: 卷蓝图（如果有）
    // Message 5: 最近章节完整内容和概要
    // Message 6: 角色档案（如果有）
    // Message 7: 状态硬约束（核心记忆账本）
    // Message 8: 图谱上下文（历史事件、伏笔等）
    // Message 9: 章节意图（来自推理或预生成章纲）
    // Message 10: 写作任务说明
    // Message 11: 字数限制
    // Message 12: 执行指令
    return messages; // 12条消息
}
```

#### 关键改进点

1. **参考 `buildMessagesForDirectWriting` 的结构**
   - 保持与直接写作模式相同的上下文丰富度
   - 确保章纲写作和直接写作的质量一致

2. **增强章节意图展示**
   - 不仅展示 `direction` 和 `keyPlotPoints`
   - 还展示 `emotionalTone`（情感基调）
   - 还展示 `foreshadowAction` 和 `foreshadowDetail`（伏笔操作和详情）
   - 还展示 `subplot`（支线剧情）
   - 还展示 `antagonism`（对抗关系）

3. **添加详细日志**
   - 输出每条消息的摘要，便于调试
   - 记录上下文组件的添加情况

---

## 📊 效果对比

### 修改前（简陋版）

```
输入：
- 章纲：主角在拍卖会上竞拍神秘丹药
- 关键剧情点：拍卖会开场、神秘丹药出现、主角出价

AI 写作：
- ❌ 不知道这是修仙世界还是都市世界
- ❌ 不知道主角性格是谨慎还是张扬
- ❌ 不知道前文剧情（为什么来拍卖会？）
- ❌ 不知道本卷目标（为什么要这个丹药？）
- ❌ 可能写出：主角高调出价，引发全场哗然（违背人设）
```

### 修改后（完整版）

```
输入：
- 章纲：主角在拍卖会上竞拍神秘丹药
- 核心设定：修仙世界，丹药分九品，主角筑基期
- 卷蓝图：本卷目标突破金丹期，需要筑基丹
- 图谱：上一章主角得知拍卖会有筑基丹
- 角色档案：主角性格谨慎、低调
- 最近章节：第49章主角在黑市打听消息

AI 写作：
- ✅ 知道这是修仙世界，丹药有等级
- ✅ 知道主角性格谨慎，会低调行事
- ✅ 知道前文剧情，自然衔接
- ✅ 知道本卷目标，明确动机
- ✅ 写出：主角低调入场，谨慎出价，避免暴露实力（符合人设）
```

---

## 🎯 核心优势

1. **章纲 + 上下文 = 方向 + 细节**
   - 章纲提供剧情方向和关键剧情点
   - 上下文提供世界观、人设、前文剧情、本卷目标
   - AI 写作质量更稳定，不会偏离

2. **与直接写作模式保持一致**
   - 两种模式使用相同的上下文结构
   - 确保无论有无章纲，写作质量都一致

3. **支持预生成章纲和实时推理**
   - 有预生成章纲：跳过推理，直接用章纲 + 上下文写作
   - 无预生成章纲：实时推理 → 生成 plotIntent → 用 plotIntent + 上下文写作
   - 两种路径最终都走 `buildMessagesFromIntent`，确保一致性

4. **详细日志便于调试**
   - 输出每条消息的摘要
   - 记录上下文组件的添加情况
   - 便于排查写作质量问题

---

## 📝 使用流程

### 流程1：使用预生成章纲写作

```
1. 生成卷级章纲
   POST /api/volumes/{volumeId}/chapter-outlines/generate
   → 生成50章章纲，落库到 volume_chapter_outlines

2. 写作章节
   POST /api/agentic/generate-chapters-stream
   → AgenticChapterWriter.generateChapter()
   → 查询预生成章纲（outlineRepository.findByNovelAndGlobalChapter）
   → 找到章纲：convertOutlineToIntent() → plotIntent
   → 收集上下文（核心设定、卷蓝图、图谱、角色、最近章节）
   → buildMessagesFromIntent(novel, context, plotIntent, chapterNumber, stylePromptFile)
   → AI 写作（章纲 + 完整上下文）
```

### 流程2：无章纲时实时推理写作

```
1. 写作章节
   POST /api/agentic/generate-chapters-stream
   → AgenticChapterWriter.generateChapter()
   → 查询预生成章纲（未找到）
   → 实时推理：PlotReasoningService.reasonPlotIntent() → plotIntent
   → 收集上下文（核心设定、卷蓝图、图谱、角色、最近章节）
   → buildMessagesFromIntent(novel, context, plotIntent, chapterNumber, stylePromptFile)
   → AI 写作（推理意图 + 完整上下文）
```

**两种流程最终都走 `buildMessagesFromIntent`，确保写作质量一致！**

---

## 🗂️ 相关文件

### 修改的文件

- `backend/src/main/java/com/novel/agentic/service/StructuredMessageBuilder.java`
  - 增强 `buildMessagesFromIntent` 方法
  - 参考 `buildMessagesForDirectWriting` 的结构
  - 添加核心设定、卷蓝图、图谱、角色、最近章节

### 新增的文件

- `backend/docs/api_examples/generate_volume_chapter_outlines.md`
  - 生成卷级章纲接口调用示例
  - 包含请求示例、响应示例、字段说明、使用流程

- `backend/sql/volume_chapter_outlines_and_foreshadow_lifecycle.sql`
  - 两张表的建表语句（带详细注释）
  - 使用说明与查询示例
  - 数据迁移与兼容性说明
  - 性能优化建议

- `backend/docs/章纲写作架构优化总结.md`（本文件）
  - 问题分析、解决方案、代码修改、效果对比

---

## 🚀 下一步建议

1. **测试写作流程**
   - 生成一卷章纲（50章）
   - 写作几章，对比有无章纲的质量差异
   - 检查是否符合世界观、人设、前文剧情

2. **优化提示词**
   - 根据实际写作效果，调整各部分的权重
   - 例如：核心设定是否需要更详细？卷蓝图是否需要更精简？

3. **监控成本**
   - 完整上下文会增加 token 消耗
   - 建议监控每章的 token 使用量
   - 必要时可以对某些部分做截断（但不建议过度截断）

4. **A/B 测试**
   - 同一章纲，分别用"简陋版"和"完整版"写作
   - 对比质量差异（人设一致性、剧情连贯性、世界观符合度）
   - 验证"完整版"的价值

---

## 📌 总结

**用户的担忧完全正确！**

- ❌ 只用章纲，不加上下文 → AI 容易偏离原本风格
- ✅ 章纲 + 完整上下文 → AI 写作质量稳定、符合世界观、人设一致

**修改后的架构：**

```
章纲（方向） + 完整上下文（约束和细节） = 高质量章节
```

**核心理念：**

- 章纲提供"去哪里"（剧情方向、关键剧情点）
- 上下文提供"怎么去"（世界观规则、人设约束、前文剧情、本卷目标）
- 两者结合，AI 才能写出"既符合方向，又符合约束"的高质量内容

**编译状态：✅ 成功**

所有代码已编译通过，可以直接测试！

